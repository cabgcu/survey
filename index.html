<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Event Survey Dashboard</title>

  <style>
    :root{
      --glass-bg: rgba(0,0,0,.55);
      --glass-brd: rgba(255,255,255,.12);
      --text-muted: #ccc;
      --text-dim: #aaa;
      --focus: #9c7bd9; /* GCU-ish purple */
    }

    * { box-sizing: border-box }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:url('https://i.imgur.com/vVZcfrN.jpeg') center/cover no-repeat fixed;
      color:#fff;
      opacity:0;
      animation:fadeIn 1.2s ease forwards;
    }
    @keyframes fadeIn{to{opacity:1}}

    @media (prefers-contrast: more){
      :root{ --glass-bg: rgba(0,0,0,.75); --glass-brd: rgba(255,255,255,.25) }
    }
    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important }
    }

    /* Top bar */
    .topbar{
      position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;
      padding:1rem 2rem;background:rgba(0,0,0,.6);backdrop-filter:blur(10px);z-index:10;
      border-bottom:1px solid var(--glass-brd);
    }
    .topbar-left{display:flex;align-items:center;gap:1rem}
    .topbar-left img{height:50px}
    .title{font-size:1.8rem;font-weight:bold}

    .topbar-controls{display:flex;gap:1rem;align-items:center}
    #search,#sortMode{
      width:260px;padding:.55rem 1rem;font-size:1rem;border:none;border-radius:8px;
      background:rgba(255,255,255,.2);color:#fff;
    }
    #search::placeholder{color:#fff;opacity:.85}
    #sortMode{
      appearance:none;padding:.55rem 2.25rem .55rem 1rem;
      background-image:url("data:image/svg+xml,%3Csvg fill='white' viewBox='0 0 24 24' width='18' height='18' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat:no-repeat;background-position:right .6rem center;background-size:1rem;
    }

    input,select,button{ outline: none }
    input:focus,select:focus,button:focus{
      box-shadow:0 0 0 3px color-mix(in oklab, var(--focus) 50%, transparent);
    }

    /* Grid */
    #dashboard{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
      gap:1.5rem;padding:2rem;
    }
    .card{
      background:var(--glass-bg);border:1px solid var(--glass-brd);border-radius:12px;
      padding:1.2rem;backdrop-filter:blur(8px);
    }
    .card h2{font-size:1.2rem;margin:.4rem 0}
    .rating{font-size:1.4rem;font-weight:bold;color:#ffc107}
    .resp-count{font-size:.8rem;color:var(--text-dim);margin-bottom:.8rem}
    .summary{font-style:italic;font-size:.9rem;color:var(--text-muted);margin-bottom:1rem}

    .actions{display:flex;flex-wrap:wrap;gap:.5rem}
    .btn{
      padding:.45rem .9rem;font-size:.85rem;background:rgba(255,255,255,.15);
      border:none;border-radius:6px;color:#fff;cursor:pointer;transition:transform .2s ease;
    }
    .btn:hover{transform:scale(1.05)}

    /* Banners */
    .banner{margin:1rem 2rem;padding:.8rem 1rem;border-radius:10px}
    .banner.info{background:rgba(255,255,255,.12);border:1px solid var(--glass-brd)}
    .banner.error{background:rgba(255,0,0,.15);border:1px solid rgba(255,0,0,.35)}

    /* Modal (scrollable content) */
    .modal{ position:fixed; inset:0; width:100%; height:100%; display:none; z-index:100; justify-content:center; align-items:flex-start; padding:3rem 1rem; }
    .modal.show{ display:flex; }
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.85); backdrop-filter:blur(5px) }
    .modal-content{
      position:relative; width:min(92vw, 900px); background:rgba(255,255,255,.05); color:#fff;
      padding:1.2rem; border-radius:12px; border:1px solid var(--glass-brd);
      max-height:calc(100vh - 6rem); overflow:auto; -webkit-overflow-scrolling:touch;
    }
    .close-btn{
      margin-left:auto;margin-bottom:1rem;padding:.5rem 1rem;border:none;border-radius:6px;
      background:rgba(255,255,255,.2);color:#fff;cursor:pointer;
    }
    .response-card{
      background:rgba(255,255,255,.05);padding:1rem 1.2rem;border-radius:10px;
      margin-bottom:1rem;border:1px solid rgba(255,255,255,.15);line-height:1.5;
    }
    .qa{margin-bottom:.6rem}
    .qa .label{font-weight:600;font-size:.9rem;margin-bottom:.2rem;color:#ddd}
    .qa .value{font-size:1rem;color:#fff;margin-left:.5rem}

    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    @media(max-width:640px){
      .topbar{flex-direction:column;align-items:flex-start;gap:.8rem;padding:.8rem 1rem}
      .title{font-size:1.4rem}
      .topbar-controls{width:100%;flex-direction:column;gap:.6rem}
      #search,#sortMode{width:100%;font-size:.88rem;padding:.55rem .95rem}
      #sortMode{background-position:right .75rem center;background-size:1rem}
      #dashboard{grid-template-columns:1fr;padding:1.2rem;gap:1rem}
      .card{padding:1rem}.card h2{font-size:1.05rem}.rating{font-size:1.2rem}
      .modal{padding:1.5rem .75rem}
      .modal-content{width:100%;max-height:calc(100vh - 3rem);padding:1.2rem}
      .response-card{padding:.9rem 1.1rem;font-size:.95rem}
      .qa .label{font-size:.85rem}.qa .value{font-size:.95rem}
    }
  </style>
</head>

<body>
  <!-- Live banner -->
  <div id="banner" class="banner info" role="status" aria-live="polite" hidden>Loading responses‚Ä¶</div>

  <!-- Top bar -->
  <div class="topbar" role="region" aria-label="Toolbar">
    <div class="topbar-left">
      <img src="https://i.imgur.com/oqrmQSC.png" alt="CAB Logo" aria-hidden="true">
      <div class="title">Event Survey Dashboard</div>
    </div>
    <div class="topbar-controls">
      <label class="sr-only" for="search">Search event</label>
      <input id="search" type="text" placeholder="Search event‚Ä¶" autocomplete="off" />
      <label class="sr-only" for="sortMode">Sort</label>
      <select id="sortMode" aria-label="Sort events">
        <option value="rating">‚≠ê Rating</option>
        <option value="az">üî§ A‚ÄìZ</option>
        <option value="recent">üïí Recent</option>
      </select>
    </div>
  </div>

  <!-- Event grid -->
  <div id="dashboard"></div>

  <!-- Modal (REPLACED) -->
  <div id="modal" class="modal" aria-hidden="true" aria-labelledby="modalTitle">
    <div class="modal-backdrop" data-close="backdrop"></div>
    <div class="modal-content" role="dialog" aria-modal="true">
      <button id="closeBtn" class="close-btn" aria-label="Close dialog">Close</button>

      <div style="display:flex;gap:12px;align-items:center;margin-bottom:10px;flex-wrap:wrap">
        <h3 id="modalTitle" style="margin:0">Responses</h3>

        <!-- Sort control -->
        <label for="modalSort" class="sr-only">Sort responses</label>
        <select id="modalSort" style="margin-left:8px;padding:.4rem;border-radius:6px">
          <option value="worst">Worst ‚Üí Best</option>
          <option value="best">Best ‚Üí Worst</option>
          <option value="recent">Most recent</option>
          <option value="oldest">Oldest</option>
        </select>

        <!-- Quick filters -->
        <div id="modalFilters" style="margin-left:auto;display:flex;gap:.4rem;align-items:center">
          <button class="btn filter-btn" data-filter="all" aria-pressed="true">All</button>
          <button class="btn filter-btn" data-filter="neg">Negative ‚â§2</button>
          <button class="btn filter-btn" data-filter="neu">Neutral 3</button>
          <button class="btn filter-btn" data-filter="pos">Positive ‚â•4</button>
        </div>
      </div>

      <!-- Search inside modal -->
      <div style="margin-bottom:12px;display:flex;gap:.5rem">
        <label class="sr-only" for="modalSearch">Search responses</label>
        <input id="modalSearch" placeholder="Search responses‚Ä¶" style="flex:1;padding:.5rem;border-radius:8px;border:none" />
        <button id="modalClearSearch" class="btn" style="padding:.45rem .6rem">Clear</button>
      </div>

      <div id="modalBody" style="max-height:calc(100vh - 12rem); overflow:auto"></div>
    </div>
  </div>

  <!-- Main logic -->
  <script>
    /* Config */
    const sheetID  = "1CqmQKvOkcLFV8XyzFrjK4H85skJCwRgSEwiP8j_6pMM";
    const RAW_SHEET = "Survey Responses";
    const OVW_SHEET = "Response overview";
    const stars = n => "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ".slice(0,Math.round(n))+"‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ".slice(0,5-Math.round(n));

    /* Data holders */
    let ratingMap={},briefMap={},groups={};

    /* DOM helpers */
    function el(tag, attrs={}, children=[]) {
      const node = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)){
        if (k === 'text') node.textContent = v;
        else if (k === 'html') node.innerHTML = v;
        else node.setAttribute(k,v);
      }
      for (const c of [].concat(children)) if (c) node.appendChild(c);
      return node;
    }
    function safeText(text){ const s = document.createElement('span'); s.textContent = String(text ?? ''); return s; }

    // Find a field by exact label OR regex (tolerant to wording/spacing)
    function findField(row, matcher){
      if(typeof matcher === 'string'){
        if(row[matcher]) return { key: matcher, val: row[matcher] };
        const k = Object.keys(row).find(k=>k && k.trim().toLowerCase()===matcher.trim().toLowerCase());
        return k ? { key:k, val: row[k] } : { key: matcher, val: '' };
      } else { // regex
        const k = Object.keys(row).find(k=> matcher.test(k));
        return k ? { key:k, val: row[k] } : { key: matcher.source, val: '' };
      }
    }

    /* Fetch helper with banner + basic retry */
    async function fetchSheet(name, tries=2){
      const url=`https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(name)}`;
      for(let i=0;i<tries;i++){
        try{
          const res = await fetch(url, { cache: 'no-store' });
          const raw = await res.text();
          return JSON.parse(raw.substring(47,raw.length-2));
        }catch(err){
          if(i===tries-1) throw err;
          await new Promise(r=>setTimeout(r, 400*(i+1)));
        }
      }
    }

    function showBanner(kind, text){
      const b = document.getElementById('banner');
      b.className = `banner ${kind}`; b.textContent = text; b.hidden = false;
    }
    function hideBanner(){ document.getElementById('banner').hidden = true }

    /* Initial load */
    (async()=>{
      try{
        showBanner('info','Loading responses‚Ä¶');
        const [overview,raw] = await Promise.all([fetchSheet(OVW_SHEET),fetchSheet(RAW_SHEET)]);

        // Overall ratings + summary
        overview.table.rows.forEach(r=>{
          const row=overview.table.cols.reduce((o,c,i)=>{o[c.label]=r.c[i]?r.c[i].v:"";return o},{});
          if(row["Event Name"]){
            ratingMap[row["Event Name"]]= +row["Overall Rating"] || 0;
            briefMap[row["Event Name"]] = row["General Thoughts"]||"";
          }
        });

        // Individual responses
        const hdr=raw.table.cols.map(c=>c.label);
        raw.table.rows.forEach(r=>{
          const row=hdr.reduce((o,h,i)=>{o[h]=r.c[i]?r.c[i].v:"";return o},{});
          const evt=row["Which Student Market Would You Like To Survey?"]||
                    row["Which Event Would You Like To Survey?"]||
                    "Unknown Event";
          (groups[evt]=groups[evt]||[]).push(row);
        });

        render(); hideBanner();
      }catch(e){
        console.error(e);
        showBanner('error','Could not load data. Make sure both tabs are published to the web and accessible: "Response overview" and "Survey Responses".');
      }
    })();

    /* Render dashboard */
    function render(filter="",sort="rating"){
      const dash=document.getElementById("dashboard");
      dash.innerHTML="";
      let entries=Object.entries(groups);

      if(sort==="rating") entries.sort((a,b)=>(ratingMap[b[0]]||0)-(ratingMap[a[0]]||0));
      if(sort==="az") entries.sort((a,b)=>a[0].localeCompare(b[0]));
      if(sort==="recent") entries.sort((a,b)=> (maxDate(b[1]) - maxDate(a[1])) );

      for (const [evt,resps] of entries){
        if(!evt.toLowerCase().includes(filter.toLowerCase())) continue;
        const card=document.createElement("div");card.className="card";

        const rt = ratingMap[evt];
        const sum = briefMap[evt];
        const cnt = resps.length;

        const h2 = el('h2',{ text: evt });
        const ratingDiv = el('div',{ class:'rating', html: rt ? `${stars(rt)} (${rt.toFixed(1)}/5.0)` : ''});
        const respCount = el('div',{ class:'resp-count', text: `${cnt} response${cnt!==1?"s":""}`});
        const summary = el('div',{ class:'summary', text: sum||"No summary available."});

        const actions = el('div',{ class:'actions' },[
          el('button',{ class:'btn view-btn', 'aria-label':`View responses for ${evt}`, text:'View Responses' }),
          el('button',{ class:'btn pdf-btn', 'aria-label':`Download PDF for ${evt}`, text:'Download PDF' })
        ]);

        card.append(h2,ratingDiv,respCount,summary,actions);
        dash.appendChild(card);

        card.querySelector('.view-btn').onclick=()=>openModal(evt,resps);
        card.querySelector('.pdf-btn').onclick=()=>downloadPDF(evt,rt,sum,resps);
      }
    }

    function maxDate(rows){
      const times = rows.map(r=> new Date(r.Timestamp || r.timestamp || 0).getTime() || 0);
      return Math.max(...times,0);
    }

    /* ---------------- Modal enhanced logic ---------------- */
    let currentEvent = '';
    let currentResponses = []; // raw rows for current event
    let currentRendered = []; // after sort/filter/search

    function extractRatingFromRow(row){
      const ratingKey = Object.keys(row).find(k=>{
        if(!k) return false;
        const t = k.trim().toLowerCase();
        return /(^|[^a-z])(rate|rating|score|how would you rate|overall experience|overall rating|satisfaction)([^a-z]|$)/i.test(t);
      });
      if(!ratingKey) return NaN;
      const raw = String(row[ratingKey] ?? '').trim();
      const numMatch = raw.match(/(\d+(\.\d+)?)(?=\s*\/?\s*5|\b|$)/);
      if(numMatch) return Number(numMatch[1]);
      const starCount = (raw.match(/‚òÖ/g) || []).length;
      if(starCount) return starCount;
      const digit = raw.match(/\b([0-5])\b/);
      if(digit) return Number(digit[1]);
      return NaN;
    }

    function renderModalResponses(){
      const body = document.getElementById('modalBody');
      body.innerHTML = '';

      const sortMode = document.getElementById('modalSort').value;
      const filterMode = Array.from(document.querySelectorAll('.filter-btn'))
                        .find(b=>b.getAttribute('aria-pressed')==='true')?.dataset?.filter || 'all';
      const q = (document.getElementById('modalSearch').value || '').trim().toLowerCase();

      currentRendered = currentResponses.map((row, idx)=>{
        const rating = extractRatingFromRow(row);
        const ts = new Date(row.Timestamp || row.timestamp || 0).getTime() || 0;
        return { idx, row, rating: (isNaN(rating)?null:rating), ts };
      });

      if(filterMode === 'neg'){
        currentRendered = currentRendered.filter(r => r.rating !== null && r.rating <= 2);
      } else if(filterMode === 'neu'){
        currentRendered = currentRendered.filter(r => r.rating !== null && Math.round(r.rating) === 3);
      } else if(filterMode === 'pos'){
        currentRendered = currentRendered.filter(r => r.rating !== null && r.rating >= 4);
      }

      if(q){
        currentRendered = currentRendered.filter(item => {
          const row = item.row;
          return Object.entries(row).some(([k,v])=>{
            return String(k + ' ' + (v ?? '')).toLowerCase().includes(q);
          });
        });
      }

      currentRendered.sort((a,b)=>{
        if(sortMode === 'worst'){
          if(a.rating === null && b.rating === null) return b.ts - a.ts;
          if(a.rating === null) return 1;
          if(b.rating === null) return -1;
          if(a.rating !== b.rating) return a.rating - b.rating;
          return a.ts - b.ts;
        } else if(sortMode === 'best'){
          if(a.rating === null && b.rating === null) return b.ts - a.ts;
          if(a.rating === null) return 1;
          if(b.rating === null) return -1;
          if(a.rating !== b.rating) return b.rating - a.rating;
          return b.ts - a.ts;
        } else if(sortMode === 'recent'){
          return b.ts - a.ts;
        } else if(sortMode === 'oldest'){
          return a.ts - b.ts;
        }
        return 0;
      });

      if(currentRendered.length === 0){
        const no = document.createElement('div');
        no.textContent = 'No responses match that filter/search.';
        body.appendChild(no);
        return;
      }

      currentRendered.forEach((item, j) => {
        const row = item.row;
        const wrap = document.createElement('div');
        wrap.className = 'response-card';
        const h = document.createElement('h4');
        h.textContent = `Response #${j+1}` + (item.rating !== null ? ` ‚Äî ${item.rating}/5` : '');
        wrap.appendChild(h);

        const isMarket = !!row["Which Student Market Would You Like To Survey?"];
        const orderSpecs = isMarket ? [
          "Which Student Market Would You Like To Survey?",
          "How would you rate your overall experience at the Student Market?",
          "What did you enjoy most about this market?",
          "How satisfied were you with the variety of vendors?",
          "Did you make a purchase at the market?",
          "Was this your first time attending a CAB Student Market?",
          /Any additional comments or suggestions.*Student Markets team\?/i
        ] : [
          "Which Event Would You Like To Survey?",
          "How would you rate your overall experience at this event?",
          "Was this your first time attending a CAB event?",
          "How did you hear about this event?",
          "What was your favorite part of the event?",
          "What would you change or improve for next time?",
          "How likely are you to attend a CAB event again?",
          "Did any CAB Event Staff take the time to connect with you or talk to you during the event? (If so who?)",
          /Any additional comments or suggestions.*CAB team\?/i
        ];

        const renderedKeys = new Set();
        for (const spec of orderSpecs){
          const { key, val } = findField(row, spec);
          if(!val || /Timestamp|Student ID/i.test(key)) continue;
          const qa = document.createElement('div');
          qa.className = 'qa';
          const lab = document.createElement('div'); lab.className = 'label'; lab.textContent = key;
          const valDiv = document.createElement('div'); valDiv.className = 'value'; valDiv.appendChild(safeText(val));
          qa.appendChild(lab); qa.appendChild(valDiv);
          wrap.appendChild(qa);
          renderedKeys.add(key);
        }

        Object.entries(row).forEach(([lab,val])=>{
          if(!val || renderedKeys.has(lab) || /Timestamp|Student ID/i.test(lab)) return;
          const qa = document.createElement('div');
          qa.className = 'qa';
          const labEl = document.createElement('div'); labEl.className = 'label'; labEl.textContent = lab;
          const valEl = document.createElement('div'); valEl.className = 'value'; valEl.appendChild(safeText(val));
          qa.appendChild(labEl); qa.appendChild(valEl);
          wrap.appendChild(qa);
        });

        body.appendChild(wrap);
      });
    }

    function openModal(evt,resps){
      currentEvent = evt;
      currentResponses = (resps || []).map(r => Object.assign({}, r));
      document.getElementById('modalSort').value = 'worst';
      document.getElementById('modalSearch').value = '';
      document.getElementById('modalClearSearch').disabled = true;
      document.querySelectorAll('.filter-btn').forEach(b=>{
        b.setAttribute('aria-pressed', b.dataset.filter === 'all' ? 'true' : 'false');
      });
      document.getElementById('modalTitle').textContent = `Responses ‚Äî ${evt}`;
      renderModalResponses();
      openDialog();
    }

    const modalEl = document.getElementById('modal');
    function openDialog(){
      modalEl.classList.add('show');
      modalEl.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
      setTimeout(()=>document.getElementById('modalSearch').focus(), 150);
    }
    function closeDialog(){
      modalEl.classList.remove('show');
      modalEl.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
    }
    document.getElementById('closeBtn').addEventListener('click', closeDialog);
    modalEl.addEventListener('click', (e)=>{ if(e.target.dataset.close==='backdrop') closeDialog(); });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modalEl.classList.contains('show')) closeDialog(); });

    document.getElementById('modalSort').addEventListener('change', ()=>renderModalResponses());
    document.getElementById('modalSearch').addEventListener('input', (e)=>{
      document.getElementById('modalClearSearch').disabled = !e.target.value;
      clearTimeout(window._modalSearchDeb);
      window._modalSearchDeb = setTimeout(()=>renderModalResponses(), 180);
    });
    document.getElementById('modalClearSearch').addEventListener('click', ()=>{
      document.getElementById('modalSearch').value = '';
      document.getElementById('modalClearSearch').disabled = true;
      renderModalResponses();
    });
    document.querySelectorAll('.filter-btn').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        document.querySelectorAll('.filter-btn').forEach(b=>b.setAttribute('aria-pressed','false'));
        e.currentTarget.setAttribute('aria-pressed','true');
        renderModalResponses();
      });
    });

    /* ---------------- PDF export (replaces HTML/CSV) ---------------- */
    function downloadPDF(evt, rt, sum, resps){
      const docParts = [];
      docParts.push(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${escapeHtml(evt)}</title>`);
      docParts.push(`<style>
        @page { size: letter; margin: 18mm; }
        * { box-sizing: border-box; }
        body { font-family: Arial, Helvetica, sans-serif; color:#000; padding:0; margin:0; }
        .header { display:flex; align-items:center; gap:12px; margin-bottom:16px; }
        .header img { height:48px; }
        h1 { font-size:22px; margin:0 0 6px; }
        .meta { font-size:12px; color:#333; margin-bottom:10px; }
        .rating { font-size:16px; margin:6px 0 12px; }
        .summary { font-style:italic; margin:4px 0 18px; color:#333; }
        .response { border:1px solid #ccc; border-radius:8px; padding:12px 14px; margin:10px 0; page-break-inside: avoid; }
        .response h3 { margin:0 0 8px; font-size:15px; }
        .item { margin:4px 0; line-height:1.4; }
        .label { font-weight:700; }
        .footer { margin-top:18px; font-size:11px; color:#444; }
        @media print {
          a[href]:after { content: ""; } /* hide link URLs */
        }
      </style></head><body>`);

      docParts.push(`<div class="header">
        <img src="https://i.imgur.com/xFzbl45.png" alt="CAB Logo">
        <div>
          <h1>${escapeHtml(evt)}</h1>
          <div class="meta">Generated ${new Date().toLocaleString()}</div>
        </div>
      </div>`);

      if(rt) docParts.push(`<div class="rating">${stars(rt)} (${rt.toFixed(1)}/5.0)</div>`);
      if(sum) docParts.push(`<div class="summary">${escapeHtml(sum)}</div>`);

      resps.forEach((row, j)=>{
        const lines = [];
        Object.entries(row).forEach(([lab,val])=>{
          if(!val || /Timestamp|Student ID|Which Event/i.test(lab)) return;
          lines.push(`<div class="item"><span class="label">${escapeHtml(lab)}:</span> ${escapeHtml(String(val))}</div>`);
        });
        if(!lines.length) return;
        docParts.push(`<section class="response"><h3>Response #${j+1}</h3>${lines.join("")}</section>`);
      });

      docParts.push(`<div class="footer">End of report</div>`);
      docParts.push(`</body></html>`);

      const html = docParts.join("");

      const iframe = document.createElement('iframe');
      iframe.style.position='fixed';
      iframe.style.right='0'; iframe.style.bottom='0';
      iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
      document.body.appendChild(iframe);

      const doc = iframe.contentDocument;
      doc.open(); doc.write(html); doc.close();

      whenReadyToPrint(doc, () => {
        iframe.contentWindow.focus();
        iframe.contentWindow.print();
        setTimeout(()=>{ document.body.removeChild(iframe); }, 800);
      });
    }

    function whenReadyToPrint(doc, cb){
      const imgs = Array.from(doc.images || []);
      let pending = imgs.length;
      if (pending === 0) { cb(); return; }
      const done = () => { if(--pending <= 0) cb(); };
      imgs.forEach(img => {
        if (img.complete) { done(); }
        else {
          img.addEventListener('load', done, { once:true });
          img.addEventListener('error', done, { once:true });
        }
      });
    }

    /* Utilities */
    function escapeHtml(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }

    /* UI events */
    const searchEl = document.getElementById('search');
    const sortEl = document.getElementById('sortMode');

    function debounce(fn, wait=200){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),wait); } }
    const onSearch = debounce(e=>render(e.target.value, sortEl.value), 200);

    searchEl.addEventListener('input', onSearch);
    sortEl.addEventListener('change', e=>render(searchEl.value, e.target.value));
  </script>
</body>
</html>
