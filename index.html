<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Event Survey Dashboard ‚Äî Dark Frost + White Text</title>

<style>
:root{
  --bg-img: none; /* no static default */
  --text: #ffffff;
  --focus: #9c7bd9;
  --radius-lg: 18px;
  --radius-md: 12px;
}

/* Reset */
* { box-sizing: border-box; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
html,body{ height:100%; }
body{
  margin:0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  color:var(--text);
  background: linear-gradient(180deg, rgba(0,0,0,0.4), rgba(0,0,0,0.6));
  padding-bottom:64px;
  opacity:0;
  animation:fadeIn 600ms ease forwards;
}
@keyframes fadeIn{ to { opacity: 1 } }

/* dark frosted glass (cards, modal, topbar) */
.glass,
.modal-content,
.topbar {
  background: rgba(0,0,0,0.55);
  border-radius: var(--radius-md);
  border: 1px solid rgba(255,255,255,0.12);
  backdrop-filter: blur(28px) saturate(220%);
  -webkit-backdrop-filter: blur(28px) saturate(220%);
  box-shadow: 0 8px 24px rgba(0,0,0,0.65),
              inset 0 1px 0 rgba(255,255,255,0.05);
  position: relative;
  overflow: hidden;
}
.glass::before,
.modal-content::before,
.topbar::before {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.2);
  mix-blend-mode: multiply;
  pointer-events: none;
  border-radius: inherit;
}
.glass > *,
.modal-content > *,
.topbar > * {
  position: relative;
  z-index: 1;
}

/* header */
.topbar-container { position: fixed; top: 0; left: 0; width: 100%; z-index: 30; padding: 14px 18px 8px; }
.topbar{
  display:flex; justify-content:space-between; align-items:center;
  padding: 10px 14px; border-radius: 20px;
  max-width: 1200px; margin: 0 auto;
}
.topbar-left{ display:flex; align-items:center; gap:12px; }
.topbar-left img{
  height:44px; width:auto;
  filter: drop-shadow(0 3px 8px rgba(0,0,0,0.56));
  border-radius:8px;
  background: rgba(255,255,255,0.05);
  padding:4px;
}
.title{
  font-size:1.22rem; font-weight:600; letter-spacing:-0.01em; color:#ffffff;
  line-height:1; text-shadow: 0 1px 0 rgba(0,0,0,0.45);
}
.topbar-controls{ display:flex; gap:12px; align-items:center }
input[type="text"], select {
  border: none; padding:.52rem .9rem; font-size:.96rem; border-radius:12px;
  background: rgba(0,0,0,0.45); min-height:38px; color:#ffffff; outline:none;
  border: 1px solid rgba(255,255,255,0.15);
  backdrop-filter: blur(18px) saturate(200%); -webkit-backdrop-filter: blur(18px) saturate(200%);
}
input::placeholder{ color:#ffffff; opacity:1; }
select {
  -webkit-appearance: none; -moz-appearance: none; appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='18' height='18' fill='%23ffffff'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 10px center; background-size: 1rem; padding-right: 2.2rem;
}
input:focus, select:focus, button:focus {
  box-shadow: 0 0 0 6px color-mix(in oklab, var(--focus) 14%, transparent), inset 0 0 0 1px var(--focus);
}

/* grid */
#dashboard{
  display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.25rem; padding: 20px; max-width: 1200px; margin: 100px auto 80px;
}
.card{
  padding: 16px; border-radius: var(--radius-lg);
  transition: transform .18s ease, box-shadow .18s ease; cursor: default;
  min-height: 110px; display:flex; flex-direction:column; gap:8px;
}
.card:hover{ transform: translateY(-6px); box-shadow: 0 12px 24px rgba(0,0,0,0.7); }
.card img.header { width:100%; max-height:160px; object-fit:cover; border-radius:12px; margin-bottom:10px; }
.card h2{ font-size:1.05rem; margin:0; font-weight:600; color:#ffffff }
.rating{ font-size:1.2rem; font-weight:700; color:#ffcb45; letter-spacing:0.02em }
.attendance{ font-size:1.05rem; font-weight:700; color:#ffffff }
.resp-count{ font-size:.82rem; color:#ffffff }
.summary{ font-style:italic; font-size:.9rem; color:#ffffff; margin-top:4px }
.actions{ display:flex; gap:8px; margin-top:auto; flex-wrap:wrap }
.btn{
  padding:.5rem .85rem; font-size:.86rem; border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.15); background: rgba(0,0,0,0.45);
  cursor:pointer; color:#ffffff;
  box-shadow: 0 2px 8px rgba(0,0,0,0.45);
}
.btn:hover{ transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.65); }

/* modal */
.modal{ position:fixed; inset:0; width:100%; height:100%; display:none; z-index:100; justify-content:center; align-items:flex-start; padding:48px 20px; }
.modal.show{ display:flex }
.modal-backdrop{ position:fixed; inset:0; background:rgba(6,8,12,0.6); backdrop-filter: blur(12px); }
.modal-content{
  position:relative; width:min(92vw, 980px); max-height:calc(100vh - 8rem); overflow:auto;
  border-radius: calc(var(--radius-lg) + 4px); padding: 18px; margin-top: 20px;
  color:#ffffff;
}
.close-btn{
  position:absolute;
  top:12px;
  right:12px;
  margin:0;
  padding:.5rem .9rem;
  border:none;
  border-radius:10px;
  background:rgba(0,0,0,0.45);
  color:#ffffff;
  cursor:pointer;
  border:1px solid rgba(255,255,255,0.15);
}
.response-card{ background: rgba(0,0,0,0.55); padding:12px 14px;border-radius:12px;margin-bottom:12px; border: 1px solid rgba(255,255,255,0.12); box-shadow: 0 8px 24px rgba(0,0,0,0.55); line-height:1.45; color:#ffffff; }
.qa{ margin-bottom:.6rem }
.qa .label{ font-weight:700; font-size:.9rem; color:#ffffff }
.qa .value{ font-size:1rem; color:#ffffff; margin-left:.25rem }
.star-badge{margin-left:8px;color:#ffcb45;font-weight:700;}

/* responsive */
@media (max-width: 640px){
  .topbar-container { padding: 12px 10px; }
  .topbar{ padding:10px; gap:10px; }
  .title{ font-size:1.05rem }
  #dashboard{ grid-template-columns: 1fr; padding:12px; gap:12px; margin: 90px auto 80px; }
  .modal{ padding: 18px 10px; align-items:flex-end }
  .modal-content{ width:100%; max-height: calc(100vh - 3.5rem); margin-top: 0; padding: 12px }
  .card{ padding:12px }
  .topbar-controls input { display:none; } /* hide search bar on mobile */
}
</style>
</head>
<body>
<div class="topbar-container">
  <div class="topbar">
    <div class="topbar-left">
      <img src="https://i.imgur.com/oqrmQSC.png" alt="CAB Logo">
      <div class="title">Event Survey Dashboard</div>
    </div>
    <div class="topbar-controls">
      <input id="search" type="text" placeholder="Search event‚Ä¶" autocomplete="off" />
      <select id="sortMode">
        <option value="rating">‚≠ê Rating</option>
        <option value="az">üî§ A‚ÄìZ</option>
        <option value="recent">üïí Recent</option>
        <option value="attendance">üë• Attendance</option>
      </select>
    </div>
  </div>
</div>

<div id="dashboard"></div>

<!-- modal -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-backdrop" data-close="backdrop"></div>
  <div class="modal-content">
    <button id="closeBtn" class="close-btn">Close</button>
    <div style="display:flex;align-items:center;gap:8px;margin:40px 0 12px;">
      <select id="modalSort">
        <option value="worst">Worst ‚Üí Best</option>
        <option value="best">Best ‚Üí Worst</option>
        <option value="newest">Newest</option>
        <option value="oldest">Oldest</option>
        <option value="az">A‚ÄìZ</option>
      </select>
    </div>
    <h3 id="modalTitle">Responses</h3>
    <div id="modalBody"></div>
  </div>
</div>

<script>
const sheetID="1CqmQKvOkcLFV8XyzFrjK4H85skJCwRgSEwiP8j_6pMM";
const RAW_SHEET="Survey Responses",OVW_SHEET="Response overview";
const stars=n=>"‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ".slice(0,Math.round(n))+"‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ".slice(0,5-Math.round(n));

let briefMap={},imageMap={},attendanceMap={},surveysMap={},groups={},bgImages=[];
const keyEvent=n=>String(n||"").trim();

function el(tag,attrs={},children=[]){
  const node=document.createElement(tag);
  for(const[k,v]of Object.entries(attrs)){
    if(k==='text')node.textContent=v;
    else if(k==='html')node.innerHTML=v;
    else node.setAttribute(k,v);
  }
  [].concat(children).forEach(c=>c&&node.appendChild(c));
  return node;
}

async function fetchSheet(name){
  const url=`https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(name)}`;
  const res=await fetch(url); const raw=await res.text();
  return JSON.parse(raw.substring(47,raw.length-2));
}

/* INIT */
(async()=>{
  const [overview,raw]=await Promise.all([fetchSheet(OVW_SHEET),fetchSheet(RAW_SHEET)]);

  // Overview (for images, summaries, attendance)
  overview.table.rows.forEach(r=>{
    const row=overview.table.cols.reduce((o,c,i)=>{o[c.label]=r.c[i]?r.c[i].v:"";return o},{});
    if(row["Event Name"]){
      briefMap[row["Event Name"]]=row["General Thoughts"]||"";
      imageMap[row["Event Name"]]=row["Header Image"]||"";
      surveysMap[row["Event Name"]]=+row["Total Surveys"]||0;
      attendanceMap[row["Event Name"]]=+row["Attendance"]||0;
      if(row["Header Image"]) bgImages.push(row["Header Image"]);
    }
  });

  // Raw responses
  const hdr=raw.table.cols.map(c=>c.label);
  raw.table.rows.forEach(r=>{
    const row=hdr.reduce((o,h,i)=>{o[h]=r.c[i]?r.c[i].v:"";return o},{});
    const ev=keyEvent(row["Which Student Market Would You Like To Survey?"]||row["Which Event Would You Like To Survey?"]||"Unknown Event");
    (groups[ev]=groups[ev]||[]).push(row);
  });

  pickBackgroundOnce(bgImages);
  render();
})();

/* Dashboard */
function maxDate(rows){return Math.max(...rows.map(r=>new Date(r.Timestamp||0).getTime()||0),0);}
function calcAvgRating(resps){
  const scores=resps.map(getResponseScore).filter(x=>!isNaN(x));
  return scores.length?scores.reduce((a,b)=>a+b,0)/scores.length:0;
}
function render(filter="",sort="rating"){
  const dash=document.getElementById("dashboard");dash.innerHTML="";
  let entries=Object.entries(groups);
  if(sort==="rating")entries.sort((a,b)=>calcAvgRating(b[1])-calcAvgRating(a[1]));
  if(sort==="az")entries.sort((a,b)=>a[0].localeCompare(b[0]));
  if(sort==="recent")entries.sort((a,b)=>(maxDate(b[1])-maxDate(a[1])));
  if(sort==="attendance")entries.sort((a,b)=>(attendanceMap[b[0]]||0)-(attendanceMap[a[0]]||0));
  for(const[evt,resps] of entries){
    if(filter&&!evt.toLowerCase().includes(filter.toLowerCase())) continue;
    const card=el("div",{class:"card glass"});
    const img=imageMap[evt]; if(img) card.appendChild(el('img',{src:img,alt:evt+" header",class:"header"}));
    const rt=calcAvgRating(resps);
    const sum=briefMap[evt]||"", cnt=surveysMap[evt]||(resps?.length||0), att=attendanceMap[evt]||0;
    const h2=el('h2',{text:evt});
    const ratingDiv=el('div',{class:'rating',html:rt?`${stars(rt)} (${rt.toFixed(1)}/5.0)`:"No ratings yet"});
    const attendanceDiv=el('div',{class:'attendance',html:`<b>Attendance:</b> ${att||"N/A"}`});
    const respCount=el('div',{class:'resp-count',text:`${cnt} survey${cnt!==1?"s":""}`});
    const summary=el('div',{class:'summary',text:sum||"No summary available."});
    const actions=el('div',{class:'actions'},[
      el('button',{class:'btn view-btn',text:'View Responses'}),
      el('button',{class:'btn pdf-btn',text:'Download PDF'})
    ]);
    card.append(h2,ratingDiv,attendanceDiv,respCount,summary,actions);
    dash.appendChild(card);
    card.querySelector('.view-btn').onclick=()=>openModal(evt,resps);
    card.querySelector('.pdf-btn').onclick=()=>downloadPDF(evt,rt,sum,att,resps);
  }
}

/* Rating Detection */
function getResponseScore(row){
  const keys=[
    "How would you rate your overall experience at the Student Market?",
    "How would you rate your overall experience at this event?"
  ];
  for(const k of keys){
    if(row[k]!=null&&row[k]!==""){
      const n=Number(row[k]);
      if(!isNaN(n)&&n>=1&&n<=5) return n;
    }
  }
  for(const [lab,val] of Object.entries(row)){
    if(/\brate\b/i.test(lab)&&val){
      const n=Number(val);
      if(!isNaN(n)&&n>=1&&n<=5) return n;
    }
  }
  return NaN;
}

/* Helpers */
function getTimestamp(row){
  const t=row.Timestamp||row["timestamp"]||"";
  const ms=Date.parse(t);
  return Number.isFinite(ms)?ms:0;
}
function getAnswerText(row){
  for(const [k,v] of Object.entries(row)){
    if(!v) continue;
    if(/Timestamp|Student ID/i.test(k)) continue;
    return String(v);
  }
  return "";
}
function sortResponses(list,mode){
  const arr=list.map((r,i)=>({row:r,idx:i,score:getResponseScore(r),ts:getTimestamp(r),text:getAnswerText(r)}));
  if(mode==="worst"){const any=arr.some(x=>!isNaN(x.score));
    if(any){arr.sort((a,b)=>(isNaN(a.score)?Infinity:a.score)-(isNaN(b.score)?Infinity:b.score)||a.idx-b.idx);}
    else{arr.sort((a,b)=>b.ts-a.ts||a.idx-b.idx);}
  }else if(mode==="best"){arr.sort((a,b)=>(isNaN(b.score)?-Infinity:b.score)-(isNaN(a.score)?-Infinity:a.score)||a.idx-b.idx);}
  else if(mode==="newest"){arr.sort((a,b)=>b.ts-a.ts||a.idx-b.idx);}
  else if(mode==="oldest"){arr.sort((a,b)=>a.ts-b.ts||a.idx-b.idx);}
  else if(mode==="az"){arr.sort((a,b)=>a.text.localeCompare(b.text));}
  return arr.map(x=>x.row);
}

/* Modal */
let currentModal={event:"",raw:[],mode:"worst"};
function openModal(evt,resps){
  currentModal={event:evt,raw:resps.slice(),mode:"worst"};
  document.getElementById("modalSort").value="worst";
  document.getElementById("modalTitle").textContent=`Responses ‚Äî ${evt}`;
  renderModalBody();
  document.getElementById("modal").classList.add("show");
}
function renderModalBody(){
  const body=document.getElementById("modalBody"); body.innerHTML="";
  const sorted=sortResponses(currentModal.raw,currentModal.mode);
  sorted.forEach((row,j)=>{
    const wrap=document.createElement("div"); wrap.className="response-card";
    const score=getResponseScore(row);
    const badge=!isNaN(score)?`<span class="star-badge">${"‚òÖ".repeat(score)}${"‚òÜ".repeat(5-score)} (${score}/5)</span>`:`<span class="star-badge">No rating</span>`;
    const h=document.createElement("h4");
    h.textContent=`Response #${j+1}`; h.insertAdjacentHTML("beforeend"," "+badge);
    wrap.appendChild(h);
    Object.entries(row).forEach(([lab,val])=>{
      if(!val||/Timestamp|Student ID/i.test(lab))return;
      const qa=document.createElement("div"); qa.className="qa";
      qa.innerHTML=`<div class="label">${lab}</div><div class="value">${val}</div>`;
      wrap.appendChild(qa);
    });
    body.appendChild(wrap);
  });
}
document.getElementById("modalSort").addEventListener("change",e=>{currentModal.mode=e.target.value;renderModalBody();});
document.getElementById("closeBtn").onclick=()=>document.getElementById("modal").classList.remove("show");
document.querySelector(".modal-backdrop").onclick=()=>document.getElementById("modal").classList.remove("show");

/* PDF */
function downloadPDF(evt,rt,sum,att,resps){
  let html=`<html><head><meta charset="UTF-8"><title>${evt}</title><style>
  body{font-family:Arial,sans-serif;color:#000;}
  .header{display:flex;align-items:center;gap:12px;margin-bottom:16px;}
  .header img{max-height:80px;}
  h1{font-size:22px;margin:0 0 6px;}
  .rating{margin:6px 0 12px;}
  .summary{font-style:italic;margin:4px 0 18px;}
  .response{border:1px solid #ccc;border-radius:8px;padding:12px;margin:10px 0;}
  </style></head><body>`;
  html+=`<div class="header"><img src="https://i.imgur.com/xFzbl45.png" alt="CAB Logo"><div><h1>${evt}</h1></div></div>`;
  if(rt)html+=`<div class="rating">${stars(rt)} (${rt.toFixed(1)}/5.0)</div>`;
  html+=`<div style="font-weight:700;"><b>Attendance:</b> ${att||"N/A"}</div>`;
  if(sum)html+=`<div class="summary">${sum}</div>`;
  const sorted=sortResponses(resps,currentModal.event===evt?currentModal.mode:"worst");
  sorted.forEach((row,j)=>{
    const lines=[];Object.entries(row).forEach(([lab,val])=>{
      if(!val||/Timestamp|Student ID/i.test(lab))return;
      lines.push(`<div><b>${lab}:</b> ${val}</div>`);
    });
    if(lines.length)html+=`<div class="response"><h3>Response #${j+1}</h3>${lines.join("")}</div>`;
  });
  html+=`</body></html>`;
  const win=window.open(""); win.document.write(html); win.document.close(); win.print();
}

/* Background */
function pickBackgroundOnce(urls){
  const valid=[...new Set((urls||[]).filter(u=>/^https?:\/\//i.test(u)))];
  if(!valid.length) return;
  const chosen=valid[Math.floor(Math.random()*valid.length)];
  document.body.style.background=`linear-gradient(180deg, rgba(0,0,0,0.4), rgba(0,0,0,0.6)), url('${chosen}') center/cover no-repeat fixed`;
}

/* Topbar */
document.getElementById('search').addEventListener('input',e=>render(e.target.value,document.getElementById('sortMode').value));
document.getElementById('sortMode').addEventListener('change',e=>render(document.getElementById('search').value,e.target.value));
</script>
</body>
</html>
