<!DOCTYPE html>
<html lang="en">
<head>
  <style>@font-face { font-family: 'Thunder'; src: url('Thunder-Regular.otf') format('opentype'); font-weight: normal; font-style: normal; }</style>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>CAB Event Evaluation Responses</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: url('https://i.imgur.com/IYZzkfE.png') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      margin: 0;
      padding: 2rem;
    }
    .header-container {
      text-align: center;
      margin-bottom: 2.5rem;
      animation: fadeIn 1.5s ease;
    }
    h1 {
      font-family: 'Thunder', sans-serif;
      font-size: 2.2rem;
      color: #fff;
      backdrop-filter: blur(6px);
      margin-bottom: 0.3rem;
      transition: all 0.3s ease;
    }
    h1:hover {
      text-shadow: 0 0 12px rgba(255, 255, 255, 0.25);
    }
    .header-subtitle {
      font-size: 1rem;
      color: #ccc;
      font-weight: 400;
      margin-top: 0;
      font-style: italic;
      opacity: 0.85;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes expand {
      from { max-height: 0; opacity: 0; }
      to { max-height: 1000px; opacity: 1; }
    }
    summary::marker { display: none; }
    details[open] > .response-block {
      animation: expand 0.5s ease;
    }
    #search {
      display: block;
      margin: 2rem auto;
      padding: 0.8rem 1.2rem;
      font-size: 1.1rem;
      border-radius: 8px;
      border: none;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      backdrop-filter: blur(10px);
      max-width: 900px;
    }
    details {
      background: rgba(0, 0, 0, 0.65);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      margin-bottom: 1.5rem;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      overflow: hidden;
      transition: background 0.3s ease, border 0.3s ease;
    }
    details[open] {
      background: rgba(0, 0, 0, 0.75);
      border: 1px solid rgba(255,255,255,0.15);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    summary {
      cursor: pointer;
      padding: 1.2rem 1.6rem;
      font-size: 1.05rem;
      font-weight: 600;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .summary-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .stars {
      font-family: system-ui;
      font-size: 0.95rem;
      color: #ccc;
    }
    .response-block {
      border-top: 1px solid rgba(255,255,255,0.15);
      padding: 1rem 1.6rem;
    }
    .response {
      margin-bottom: 1.8rem;
      padding: 1.2rem;
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .review-title {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 1rem;
      color: #fff;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      padding-bottom: 0.5rem;
    }
    .field {
      margin-bottom: 1.2rem;
      padding-bottom: 1.2rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .label {
      font-weight: 500;
      font-size: 0.85rem;
      color: #ccc;
      margin-bottom: 0.2rem;
    }
    .value {
      font-size: 1.05rem;
      font-weight: 400;
      color: #fff;
      line-height: 1.4;
    }
    #topBtn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      background: rgba(0,0,0,0.6);
      color: white;
      border: 1px solid #555;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      cursor: pointer;
      z-index: 999;
      backdrop-filter: blur(5px);
    }
    .overview-text {
      font-size: 0.9rem;
      color: #aaa;
      margin: 0.4rem 1.6rem 1rem;
      font-style: italic;
    }
  </style>
</head>
<body>
<div class="header-container">
  <img src="https://i.imgur.com/oqrmQSC.png" alt="CAB Logo" style="width: 100px; margin-bottom: -0.3rem; margin-top: 0.5rem; filter: drop-shadow(0 0 4px rgba(0,0,0,0.4));">
  <h1>Event Evaluation Responses</h1>
  <p class="header-subtitle">Anonymous student feedback collected live from each CAB event</p>
</div>
<input type="text" id="search" placeholder="Search for an event..." />
<script>
const sheetID = "1CqmQKvOkcLFV8XyzFrjK4H85skJCwRgSEwiP8j_6pMM";
const RAW_SHEET = "Survey Responses";
const OVW_SHEET = "Response overview";

async function fetchSheet(sheetName) {
  const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
  const raw = await fetch(url).then(r => r.text());
  return JSON.parse(raw.substring(47, raw.length - 2));
}

function extractEvent(row) {
  return row["Which Event Would You Like To Survey?"] ||
         row["Which Student Market Would You Like To Survey?"] ||
         row["Event Name"] || "Unknown Event";
}

function stars(n) {
  if (!n) return "";
  const s = Math.round(n);
  return "★★★★★".slice(0, s) + "☆☆☆☆☆".slice(0, 5 - s);
}

(async () => {
  const [overview, rawRes] = await Promise.all([
    fetchSheet(OVW_SHEET),
    fetchSheet(RAW_SHEET)
  ]);

  const ratingMap = {};
  const briefMap = {};
  const ovwHeaders = overview.table.cols.map(c => c.label);
  overview.table.rows.forEach(r => {
    const row = ovwHeaders.reduce((o, h, i) => {
      o[h] = r.c[i] ? r.c[i].v : "";
      return o;
    }, {});
    if (row["Event Name"]) {
      ratingMap[row["Event Name"]] = Number(row["Overall Rating"]);
      briefMap[row["Event Name"]] = row["General Thoughts"] || "";
    }
  });

  const rawHeaders = rawRes.table.cols.map(c => c.label);
  const rawRows = rawRes.table.rows.map(r =>
    rawHeaders.reduce((o, h, i) => {
      o[h] = r.c[i] ? r.c[i].v : "";
      return o;
    }, {})
  );

  const groups = {};
  rawRows.forEach(r => {
    const event = extractEvent(r);
    if (!groups[event]) groups[event] = [];
    groups[event].push(r);
  });

  const dash = document.createElement("div");
  dash.id = "dash";
  document.body.insertBefore(dash, document.getElementById("topBtn"));

  const searchInput = document.getElementById("search");

  function render(filter = "") {
    dash.innerHTML = "";
    let hasResults = false;
    Object.entries(groups).sort((a, b) => b[0].localeCompare(a[0])).forEach(([event, responses]) => {
      if (!event.toLowerCase().includes(filter.toLowerCase())) return;
      hasResults = true;
      const det = document.createElement("details");
      const sum = document.createElement("summary");
      const rating = ratingMap[event];
      const overview = briefMap[event];

      sum.innerHTML = `<span class="summary-left"><span class="event-label">${event}</span><span class="dropdown">▼</span></span><span class="stars">${rating ? `${stars(rating)} (${rating.toFixed(1)}/5.0)` : ""}</span>`;
      det.appendChild(sum);

      if (overview) {
        const desc = document.createElement("div");
        desc.className = "overview-text";
        desc.textContent = overview;
        det.appendChild(desc);
      }

      const block = document.createElement("div");
      block.className = "response-block";

      responses.forEach((res, i) => {
        const div = document.createElement("div");
        div.className = "response";

        const title = document.createElement("div");
        title.className = "review-title";
        title.textContent = `Student Survey #${i + 1}`;
        div.appendChild(title);

        Object.entries(res).forEach(([label, val]) => {
          if (!val || label.includes("Timestamp") || label.includes("Student ID") || label.includes("Which Event") || label.includes("Which Student Market")) return;
          const field = document.createElement("div");
          field.className = "field";
          field.innerHTML = `<div class="label">${label}</div><div class="value">${val}</div>`;
          div.appendChild(field);
        });

        block.appendChild(div);
      });

      det.appendChild(block);
      dash.appendChild(det);
    });

    if (!hasResults) {
      dash.innerHTML = "<p style='text-align:center; color: white; font-size: 1rem;'>No matching events found. Try another search.</p>";
    }
  }

  render();
  searchInput.addEventListener("input", () => render(searchInput.value));
})();
</script>
</body>
</html>
