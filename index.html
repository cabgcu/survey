<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>CAB Event Survey System</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --bg-dark: #000000;
            --glass-surface: rgba(0, 0, 0, 0.65); 
            --glass-border: rgba(255, 255, 255, 0.18);
            --text-main: #ffffff;
            --text-muted: #d1d1d6;
            --gradient-accent: linear-gradient(135deg, #0A84FF, #BF5AF2);
            --gradient-fire: linear-gradient(135deg, #FF9500, #FF3B30);
            --gradient-success: linear-gradient(135deg, #34C759, #30B0C7);
            --radius-card: 28px;
            --radius-btn: 16px;
            --blur-bg: 2px; 
            --blur-card: 12px;
            --max-width-content: 650px;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Segoe UI", Roboto, sans-serif; 
            color: var(--text-main); 
            background-color: var(--bg-dark); 
            min-height: 100vh; 
            overflow-x: hidden; 
        }

        .no-save-pass { -webkit-text-security: disc !important; text-security: disc !important; }

        #bg-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -2; overflow: hidden; background: #000; }
        .bg-slide { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-size: cover; background-position: center; opacity: 0; transition: opacity 2s ease-in-out; }
        .bg-slide.active { opacity: 0.7; }
        
        #bg-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: rgba(0, 0, 0, 0.45); backdrop-filter: blur(var(--blur-bg)); -webkit-backdrop-filter: blur(var(--blur-bg)); }

        .app-container { position: relative; max-width: 1280px; margin: 0 auto; padding: 20px 16px; min-height: 100vh; display: flex; flex-direction: column; }
        @media (min-width: 768px) { .app-container { padding: 40px 24px; } }

        .view { display: none; opacity: 0; transform: translateY(10px); transition: 0.3s ease; }
        .view.active { display: block; opacity: 1; transform: translateY(0); animation: fadeUp 0.4s ease forwards; }
        
        .hero-banner { width: 100%; max-width: var(--max-width-content); margin: 0 auto 24px; border-radius: var(--radius-card); overflow: hidden; border: 1px solid var(--glass-border); box-shadow: 0 10px 30px rgba(0,0,0,0.5); background: #111; line-height: 0; }
        .hero-banner img { width: 100%; height: auto; display: block; }
        
        .frosted { background: var(--glass-surface); backdrop-filter: blur(var(--blur-card)); -webkit-backdrop-filter: blur(var(--blur-card)); border: 1px solid var(--glass-border); box-shadow: 0 30px 80px rgba(0,0,0,0.6); }
        .survey-card { width: 100%; max-width: var(--max-width-content); margin: 0 auto 40px; padding: 24px; border-radius: var(--radius-card); }
        @media (min-width: 768px) { .survey-card { padding: 40px; } }

        .form-group { margin-bottom: 28px; }
        .form-label { display: block; margin-bottom: 12px; color: var(--text-muted); font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.06em; line-height: 1.4; }

        .required-mark { color: #FF3B30; margin-left: 4px; font-weight: bold; }
        
        input.control-item, select.control-item, textarea.control-item { 
            width: 100%; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); 
            color: #fff; padding: 16px 20px; border-radius: var(--radius-btn); font-family: inherit; font-size: 1rem; 
            outline: none; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }

        .control-item:focus { 
            border-color: #0A84FF; 
            background: rgba(255,255,255,0.12); 
            box-shadow: 0 0 15px rgba(10, 132, 255, 0.4), 0 0 2px rgba(191, 90, 242, 0.4);
            transform: scale(1.01);
        }

        select.control-item { appearance: none; -webkit-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 24px center; background-size: 16px; padding-right: 52px; }
        textarea.control-item { min-height: 120px; resize: vertical; }
        
        .rating-stars { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
        .star { font-size: 2.2rem; cursor: pointer; color: rgba(255,255,255,0.15); transition: 0.2s; }
        @media (min-width: 768px) { .star { font-size: 2.8rem; } }
        .star.selected { color: #FFD60A; filter: drop-shadow(0 0 10px rgba(255,214,10,0.3)); }
        
        #dashboard { display: grid; grid-template-columns: 1fr; gap: 24px; margin-bottom: 60px; }
        @media (min-width: 768px) { #dashboard { grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 28px; } }

        .card { border-radius: var(--radius-card); overflow: hidden; display: flex; flex-direction: column; transition: 0.3s; height: 100%; }
        .card:hover { transform: translateY(-8px); box-shadow: 0 50px 100px rgba(0,0,0,0.9); }
        .card-header { position: relative; height: 160px; border-bottom: 1px solid var(--glass-border); }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .card-body { padding: 24px; flex: 1; }
        
        .btn { padding: 18px 32px; border-radius: var(--radius-btn); font-weight: 700; cursor: pointer; border: none; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; text-decoration: none; font-size: 1rem; width: 100%; }
        @media (min-width: 768px) { .btn { width: auto; } }

        .btn-primary { background: var(--gradient-accent); color: white; box-shadow: 0 10px 20px rgba(10, 132, 255, 0.2); }
        .btn-ghost { background: transparent; border: 1px solid rgba(255,255,255,0.1); color: var(--text-muted); }
        .badge { display: inline-block; padding: 4px 10px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; background: rgba(255,255,255,0.08); margin-right: 6px; }
        
        .list-manager { margin-top: 10px; max-height: 250px; overflow-y: auto; padding-right: 8px; }
        .list-row { display: flex; align-items: center; background: rgba(255,255,255,0.03); padding: 12px 18px; border-radius: 14px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.08); gap: 12px; }
        .list-name { flex: 1; font-size: 0.95rem; line-height: 1.4; }
        .list-remove { color: #FF3B30; cursor: pointer; font-size: 1.4rem; font-weight: bold; width: 32px; text-align: center; }
        
        /* MOVE CONTROLS */
        .move-controls { display: flex; gap: 4px; margin-right: 8px; }
        .move-btn { background: rgba(255, 255, 255, 0.1); border: none; color: white; width: 28px; height: 28px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; transition: 0.2s; }
        .move-btn:hover { background: rgba(255, 255, 255, 0.2); }
        .move-btn:disabled { opacity: 0.1; cursor: not-allowed; }

        .modal { position: fixed; inset: 0; z-index: 1000; display: none; justify-content: center; align-items: center; padding: 16px; }
        .modal.show { display: flex; }
        .modal-bg { position: absolute; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); }
        .modal-content { position: relative; width: 100%; max-width: 400px; background: #000; border-radius: 32px; padding: 32px; border: 1px solid var(--glass-border); }
        
        .loader { display: none; width: 18px; height: 18px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; animation: rotation 1s linear infinite; margin-left: 10px; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        #toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; padding: 16px 24px; border-radius: 100px; background: var(--gradient-success); font-weight: 700; z-index: 2000; display: none; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.5); }
        
        .settings-grid { display: grid; grid-template-columns: 1fr; gap: 40px; }
        @media (min-width: 992px) { .settings-grid { grid-template-columns: 1fr 1fr; } }
        .settings-section { margin-bottom: 60px; } 
        .settings-title { color:var(--text-muted); font-size:0.8rem; font-weight:800; letter-spacing:0.12em; margin-bottom:24px; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:12px; text-transform: uppercase; }

        footer { margin-top:auto; padding:60px 0 40px; text-align:center; color: rgba(255, 255, 255, 0.4); font-size: 0.75rem; letter-spacing: 0.05em; line-height: 1.6; }
        
        .center-btn-wrapper { display: flex; justify-content: center; width: 100%; margin-top: 20px; }

        .success-icon { width: 80px; height: 80px; background: var(--gradient-success); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 24px; font-size: 40px; color: white; box-shadow: 0 10px 20px rgba(52, 199, 89, 0.3); }

        .survey-header-center { text-align: center; margin-bottom: 30px; }
    </style>
</head>
<body>

<div id="bg-container"></div>
<div id="bg-overlay"></div>

<div class="app-container">
    <div class="hero-banner" id="bannerContainer"><img id="bannerImg" src="https://i.imgur.com/HJTTEzA.png" alt="CAB Banner"></div>

    <div id="surveyView" class="view active">
        <div class="frosted survey-card">
            <div class="survey-header-center">
                <h3 style="margin-top:0; font-size: 1.8rem; letter-spacing: -0.02em;" id="surveyTitle">Event Experience Survey</h3>
                <p id="surveyDesc" style="color: var(--text-muted); margin: 10px auto; line-height: 1.6; max-width: 90%;">Help us build a better campus experience by providing your feedback.</p>
                <span style="font-size: 0.7rem; color: #FF3B30; font-weight: 700; text-transform: uppercase;">* Required Field</span>
            </div>

            <div class="form-group">
                <label class="form-label">
                    <span id="label-studentID">Please enter your Student ID number</span><span class="required-mark">*</span>
                </label>
                <input type="number" id="formStudentID" class="control-item" placeholder="Type here..." autocomplete="off" />
            </div>

            <div class="form-group">
                <label class="form-label">
                    <span id="label-eventSelect">Which Event Would You Like To Survey?</span><span class="required-mark">*</span>
                </label>
                <select id="formEvent" class="control-item" onchange="checkEventType()">
                    <option value="">Select an event...</option>
                </select>
            </div>

            <div id="branchCAB">
                <div class="form-group">
                    <label class="form-label"><span id="label-cabRating">How would you rate your overall experience at this event?</span><span class="required-mark">*</span></label>
                    <div class="rating-stars cab-stars">
                        <span class="star" data-value="1" onclick="setRating(1)">‚òÖ</span><span class="star" data-value="2" onclick="setRating(2)">‚òÖ</span><span class="star" data-value="3" onclick="setRating(3)">‚òÖ</span><span class="star" data-value="4" onclick="setRating(4)">‚òÖ</span><span class="star" data-value="5" onclick="setRating(5)">‚òÖ</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><span id="label-cabFirstTime">Was this your first time attending a CAB event?</span><span class="required-mark">*</span></label>
                    <select id="formFirstTime" class="control-item">
                        <option value="">Select...</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label"><span id="label-cabHear">How did you hear about this event?</span><span class="required-mark">*</span></label>
                    <select id="formHearAbout" class="control-item"></select>
                </div>
                <div class="form-group">
                    <label class="form-label"><span id="label-cabFavorite">What was your favorite part of the event?</span><span class="required-mark">*</span></label>
                    <textarea id="formFavorite" class="control-item" placeholder="Type here..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label"><span id="label-cabImprove">What would you change or improve for next time?</span><span class="required-mark">*</span></label>
                    <textarea id="formImprove" class="control-item" placeholder="Type here..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label"><span id="label-cabLikely">How likely are you to attend a CAB event again?</span><span class="required-mark">*</span></label>
                    <select id="formLikely" class="control-item">
                        <option value="">Select...</option>
                        <option value="Very Likely">Very Likely</option>
                        <option value="Likely">Likely</option>
                        <option value="Neutral">Neutral</option>
                        <option value="Unlikely">Unlikely</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label"><span id="label-cabStaff">Did any CAB Event Staff take the time to connect with you or talk to you during the event? (If so who?)</span><span class="required-mark">*</span></label>
                    <textarea id="formStaff" class="control-item" placeholder="Type here..."></textarea>
                </div>
            </div>

            <div id="branchMarket" style="display:none;">
                <div class="form-group">
                    <label class="form-label"><span id="label-mktRating">How would you rate your overall experience at the Student Market?</span><span class="required-mark">*</span></label>
                    <div class="rating-stars mkt-stars">
                        <span class="star" data-value="1" onclick="setRating(1)">‚òÖ</span><span class="star" data-value="2" onclick="setRating(2)">‚òÖ</span><span class="star" data-value="3" onclick="setRating(3)">‚òÖ</span><span class="star" data-value="4" onclick="setRating(4)">‚òÖ</span><span class="star" data-value="5" onclick="setRating(5)">‚òÖ</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label"><span id="label-mktFavorite">What did you enjoy most about this market?
</span><span class="required-mark">*</span></label>
                    <textarea id="mktFavorite" class="control-item" placeholder="Type here..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label"><span id="label-mktFirstTime">Was this your first time attending a CAB Student Market?</span><span class="required-mark">*</span></label>
                    <select id="mktFirstTime" class="control-item">
                        <option value="">Select...</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label"><span id="label-mktVariety">How satisfied were you with the variety of vendors?</span><span class="required-mark">*</span></label>
                    <select id="mktVariety" class="control-item">
                        <option value="">Select...</option>
                        <option value="Very Satisfied">Very Satisfied</option>
                        <option value="Satisfied">Satisfied</option>
                        <option value="Neutral">Neutral</option>
                        <option value="Unsatisfied">Unsatisfied</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label"><span id="label-mktPurchase">Did you make a purchase at the market?</span><span class="required-mark">*</span></label>
                    <select id="mktPurchase" class="control-item">
                        <option value="">Select...</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" id="label-comments">Additional comments? (Optional)</label>
                <textarea id="formComments" class="control-item" placeholder="Type here..."></textarea>
            </div>

            <div class="center-btn-wrapper">
                <button class="btn btn-primary" id="submitBtn" onclick="submitSurvey()">
                    <span>Submit Feedback</span>
                    <div class="loader" id="submitLoader"></div>
                </button>
            </div>
        </div>
    </div>

    <div id="successView" class="view">
        <div class="frosted survey-card" style="text-align: center;">
            <div class="success-icon">‚úì</div>
            <h2 style="margin-top:0">Thank You!</h2>
            <p style="color: var(--text-muted); line-height: 1.6; margin-bottom: 32px;">Your feedback has been successfully submitted.</p>
            <div class="center-btn-wrapper">
                <button class="btn btn-primary" onclick="resetFormAndReturn()">Submit Another Response</button>
            </div>
        </div>
    </div>

    <div id="settingsView" class="view">
        <div class="frosted survey-card" style="max-width: 1100px;">
            <div style="display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px;">
                <h2 style="margin:0">Admin Console</h2>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-ghost" style="padding: 10px 16px; font-size: 0.8rem; width: auto;" onclick="switchView('dashboard')">Analytics</button>
                    <button class="btn btn-ghost" style="padding: 10px 16px; font-size: 0.8rem; width: auto;" onclick="switchView('survey')">Exit Admin</button>
                </div>
            </div>

            <div class="settings-grid">
                <div>
                    <div class="settings-section">
                        <div class="settings-title">Event Management (Reorder & Market Toggle)</div>
                        <div id="event-list-manager" class="list-manager"></div>
                        <div style="display:flex; gap:8px; margin-top:16px;">
                            <input type="text" id="newEventName" class="control-item" placeholder="Event Name..." />
                            <button class="btn btn-primary" style="width: auto; padding: 0 20px;" onclick="addEventUI()">Add</button>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <div class="settings-title">Global Branding</div>
                        <div class="form-group"><label class="form-label">Banner Image URL</label><input type="text" id="setHeaderImg" class="control-item" /></div>
                        <div class="form-group"><label class="form-label">Intro Text</label><textarea id="setDesc" class="control-item" style="min-height:80px"></textarea></div>
                        <div class="form-group"><label class="form-label">New Password</label>
                            <input type="text" id="setNewPass" class="control-item no-save-pass" placeholder="Change password..." autocomplete="new-password" spellcheck="false" />
                        </div>
                    </div>
                </div>

                <div>
                    <div class="settings-section">
                        <div class="settings-title">Question Editor (CAB)</div>
                        <div class="form-group"><label class="form-label">Student ID Question</label><input type="text" id="q-studentID" class="control-item" /></div>
                        <div class="form-group"><label class="form-label">Event Selection Title</label><input type="text" id="q-eventSelect" class="control-item" /></div>
                        <div class="form-group"><label class="form-label">CAB Experience Rating</label><input type="text" id="q-cabRating" class="control-item" /></div>
                        <div class="form-group"><label class="form-label">First Time Label</label><input type="text" id="q-cabFirstTime" class="control-item" /></div>
                        <div class="form-group"><label class="form-label">Hear About Label</label><input type="text" id="q-cabHear" class="control-item" /></div>
                        <div class="form-group"><label class="form-label">Favorite Part Label</label><input type="text" id="q-cabFavorite" class="control-item" /></div>
                        <div class="form-group"><label class="form-label">Improvements Label</label><input type="text" id="q-cabImprove" class="control-item" /></div>
                        <div class="form-group"><label class="form-label">Attend Again Label</label><input type="text" id="q-cabLikely" class="control-item" /></div>
                        <div class="form-group"><label class="form-label">Staff Connect Label</label><input type="text" id="q-cabStaff" class="control-item" /></div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-title">Question Editor (Market)</div>
                        <div class="form-group"><label class="form-label">Market Experience Rating</label><input type="text" id="q-mktRating" class="control-item" /></div>
                        <div class="form-group"><label class="form-label">Market Favorite Part</label><input type="text" id="q-mktFavorite" class="control-item" /></div>
                        <div class="form-group"><label class="form-label">First Time Label</label><input type="text" id="q-mktFirstTime" class="control-item" /></div>
                        <div class="form-group"><label class="form-label">Vendor Variety Label</label><input type="text" id="q-mktVariety" class="control-item" /></div>
                        <div class="form-group"><label class="form-label">Market Purchase Label</label><input type="text" id="q-mktPurchase" class="control-item" /></div>
                        <div class="form-group"><label class="form-label">Global Comments Label</label><input type="text" id="q-comments" class="control-item" /></div>
                    </div>
                </div>
            </div>
            
            <div class="center-btn-wrapper">
                <button class="btn btn-primary" id="saveConfigBtn" onclick="saveAdminSettings()">
                    <span>Save All Changes</span>
                    <div class="loader" id="saveLoader"></div>
                </button>
            </div>
        </div>
    </div>

    <div id="dashboardView" class="view">
        <div style="margin-bottom: 40px; display:flex; flex-direction: column; gap: 12px;">
            <input id="search" class="control-item" type="text" placeholder="Search events..." />
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="syncSheetData()" class="btn btn-ghost" style="flex: 1; min-width: 120px;">üîÑ Refresh</button>
                <button onclick="switchView('settings')" class="btn btn-ghost" style="flex: 1; min-width: 120px;">‚öôÔ∏è Settings</button>
                <button onclick="switchView('survey')" class="btn btn-ghost" style="flex: 1; min-width: 120px;">Survey View</button>
            </div>
        </div>
        <div id="dashboard"></div>
    </div>

    <footer>
        ¬© 2026 Canyon Activities Board <br>
        <button class="btn btn-ghost" id="adminLoginBtn" style="font-size:0.7rem; opacity:0.4; width: auto; margin-top:10px; border:none;" onclick="showGate()">Admin Access</button>
    </footer>
</div>

<div id="gateModal" class="modal"><div class="modal-bg" onclick="hideGate()"></div>
    <div class="modal-content"><h3 style="margin-top:0">Authorization Required</h3><p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:20px;">Enter board password to continue.</p>
        <input type="text" id="adminPass" class="control-item no-save-pass" placeholder="Password" style="margin-bottom:20px" autocomplete="off" spellcheck="false" onkeyup="if(event.key==='Enter') verifyAdmin()"/>
        <button class="btn btn-primary" id="gateBtn" onclick="verifyAdmin()"><span>Authorize & Login</span><div class="loader" id="gateLoader"></div></button>
    </div>
</div>

<div id="toast">Update Successful</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw3QFydA5aCuJFFKw2A7oBEJ9G9IBoysQOGfS7XVooXJ-F23vqbfl5_LMpt1UbCERI/exec"; 
    let state = { 
        responses: [], 
        config: {}, 
        currentRating: 0, 
        view: 'survey', 
        isAdmin: false, 
        isMarket: false, 
        tempEvents: [],
        questionKeys: [
            'studentID', 'eventSelect', 'cabRating', 'cabFirstTime', 'cabHear', 'cabFavorite', 'cabImprove', 'cabLikely', 'cabStaff', 
            'mktRating', 'mktFavorite', 'mktFirstTime', 'mktVariety', 'mktPurchase', 'comments'
        ]
    };

    let bgIndex = 0;
    let bgInterval = null;

    async function init() { switchView('survey'); syncSheetData(); }

    function switchView(viewName) {
        state.view = viewName;
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        const target = document.getElementById(viewName + 'View');
        if (target) target.classList.add('active');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function syncSheetData() {
        try {
            const res = await fetch(SCRIPT_URL);
            const data = await res.json();
            state.responses = data.overview;
            state.config = data.config;
            const all = (state.config.Events || "").split(',').map(s => s.trim()).filter(Boolean);
            const mkt = (state.config.MarketEvents || "").split(',').map(s => s.trim()).filter(Boolean);
            state.tempEvents = all.map(name => ({ name, isMarket: mkt.includes(name) }));
            applyConfig();
            initBackgroundRotation();
            if (state.view === 'dashboard') renderDashboard();
        } catch (e) { console.error("Sync error", e); }
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function initBackgroundRotation() {
        const bgContainer = document.getElementById('bg-container');
        let images = state.responses.map(r => r.imageurl).filter(url => url && url.startsWith('http'));
        if (images.length === 0) return;
        images = shuffleArray(images);
        bgContainer.innerHTML = '';
        images.forEach((url, i) => {
            const slide = document.createElement('div');
            slide.className = 'bg-slide';
            slide.style.backgroundImage = `url('${url}')`;
            if (i === 0) slide.classList.add('active');
            bgContainer.appendChild(slide);
        });
        bgIndex = 0; 
        if (bgInterval) clearInterval(bgInterval);
        if (images.length > 1) {
            bgInterval = setInterval(() => {
                const slides = document.querySelectorAll('.bg-slide');
                if (slides.length === 0) return;
                slides[bgIndex].classList.remove('active');
                bgIndex = (bgIndex + 1) % slides.length;
                slides[bgIndex].classList.add('active');
            }, 8000); 
        }
    }

    function applyConfig() {
        if (state.config.HeaderImageURL) document.getElementById('bannerImg').src = state.config.HeaderImageURL;
        if (state.config.SurveyDescription) document.getElementById('surveyDesc').textContent = state.config.SurveyDescription;
        state.questionKeys.forEach(key => {
            const labelEl = document.getElementById('label-' + key);
            const inputEl = document.getElementById('q-' + key);
            const val = state.config['q-' + key];
            if (val && labelEl) labelEl.textContent = val;
            if (inputEl) inputEl.value = val || (labelEl ? labelEl.textContent : "");
        });
        document.getElementById('formEvent').innerHTML = '<option value="">Select an event...</option>' + state.tempEvents.map(e => `<option value="${e.name}">${e.name}</option>`).join('');
        const hear = (state.config.HearAboutOptions || "Instagram,Email,Flyer,LopeLife App,Word of Mouth").split(',');
        document.getElementById('formHearAbout').innerHTML = '<option value="">Select...</option>' + hear.map(h => `<option value="${h.trim()}">${h.trim()}</option>`).join('');
        document.getElementById('setHeaderImg').value = state.config.HeaderImageURL || "";
        document.getElementById('setDesc').value = state.config.SurveyDescription || "";
        renderEventSettings();
    }

    function renderEventSettings() {
        const box = document.getElementById('event-list-manager');
        box.innerHTML = state.tempEvents.map((ev, idx) => `
            <div class="list-row">
                <div class="move-controls">
                    <button class="move-btn" onclick="moveEvent(${idx}, -1)" ${idx === 0 ? 'disabled' : ''}>‚Üë</button>
                    <button class="move-btn" onclick="moveEvent(${idx}, 1)" ${idx === state.tempEvents.length - 1 ? 'disabled' : ''}>‚Üì</button>
                </div>
                <span class="list-name">${ev.name}</span>
                <label class="market-toggle" style="font-size: 0.75rem; color: var(--text-muted);">
                    <input type="checkbox" ${ev.isMarket ? 'checked' : ''} onchange="toggleMarketFlag(${idx}, this.checked)"> Market
                </label>
                <div class="list-remove" onclick="removeEventUI(${idx})">&times;</div>
            </div>
        `).join('');
    }

    function moveEvent(index, direction) {
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= state.tempEvents.length) return;
        const element = state.tempEvents.splice(index, 1)[0];
        state.tempEvents.splice(newIndex, 0, element);
        renderEventSettings();
    }

    function toggleMarketFlag(idx, val) { state.tempEvents[idx].isMarket = val; }
    function removeEventUI(idx) { state.tempEvents.splice(idx, 1); renderEventSettings(); }
    function addEventUI() { const name = document.getElementById('newEventName').value.trim(); if(!name) return; state.tempEvents.push({ name, isMarket: false }); document.getElementById('newEventName').value = ""; renderEventSettings(); }

    function checkEventType() {
        const selected = document.getElementById('formEvent').value;
        const evData = state.tempEvents.find(e => e.name === selected);
        state.isMarket = evData ? evData.isMarket : false;
        document.getElementById('branchCAB').style.display = state.isMarket ? 'none' : 'block';
        document.getElementById('branchMarket').style.display = state.isMarket ? 'block' : 'none';
        const qTitle = state.isMarket ? (state.config['q-eventSelect'] || "Which Student Market Would You Like To Survey?") : (state.config['q-eventSelect'] || "Which Event Would You Like To Survey?");
        const selectionLabel = document.getElementById('label-eventSelect');
        if (selectionLabel) selectionLabel.textContent = qTitle;
        state.currentRating = 0; document.querySelectorAll('.star').forEach(s => s.classList.remove('selected'));
    }

    function setRating(val) { state.currentRating = val; const stars = state.isMarket ? document.querySelectorAll('.mkt-stars .star') : document.querySelectorAll('.cab-stars .star'); document.querySelectorAll('.star').forEach(s => s.classList.remove('selected')); stars.forEach((s, i) => { if(i < val) s.classList.add('selected'); }); }

    function resetFormAndReturn() {
        state.currentRating = 0; state.isMarket = false;
        const formFields = ['formStudentID', 'formEvent', 'formFirstTime', 'formHearAbout', 'formFavorite', 'formImprove', 'formLikely', 'formStaff', 'mktFavorite', 'mktFirstTime', 'mktVariety', 'mktPurchase', 'formComments'];
        formFields.forEach(f => document.getElementById(f).value = "");
        document.querySelectorAll('.star').forEach(s => s.classList.remove('selected'));
        switchView('survey');
        checkEventType();
    }

    function fireConfetti() {
        const duration = 3 * 1000;
        const animationEnd = Date.now() + duration;
        const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };
        function randomInRange(min, max) { return Math.random() * (max - min) + min; }
        const interval = setInterval(function() {
            const timeLeft = animationEnd - Date.now();
            if (timeLeft <= 0) return clearInterval(interval);
            const particleCount = 50 * (timeLeft / duration);
            confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }, colors: ['#0A84FF', '#BF5AF2'] }));
            confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }, colors: ['#0A84FF', '#BF5AF2'] }));
        }, 250);
    }

    async function submitSurvey() {
        const studentID = document.getElementById('formStudentID').value;
        const event = document.getElementById('formEvent').value;
        const rating = state.currentRating;
        if (!studentID || !event || rating === 0) return showToast("Please provide ID, Event, and Rating.", true);
        let data = { studentID, event, rating, comments: document.getElementById('formComments').value, isMarket: state.isMarket };
        if (state.isMarket) {
            const favorite = document.getElementById('mktFavorite').value;
            const firstTime = document.getElementById('mktFirstTime').value;
            const variety = document.getElementById('mktVariety').value;
            const purchase = document.getElementById('mktPurchase').value;
            if (!favorite || !firstTime || !variety || !purchase) return showToast("Please answer all required questions.", true);
            data = { ...data, favoritePart: favorite, mktFirstTime: firstTime, variety, purchase };
        } else {
            const firstTime = document.getElementById('formFirstTime').value;
            const hearAbout = document.getElementById('formHearAbout').value;
            const favorite = document.getElementById('formFavorite').value;
            const improve = document.getElementById('formImprove').value;
            const likely = document.getElementById('formLikely').value;
            const staff = document.getElementById('formStaff').value;
            if (!firstTime || !hearAbout || !favorite || !improve || !likely || !staff) return showToast("Please answer all required questions.", true);
            data = { ...data, firstTime, hearAbout, favoritePart: favorite, improve, likelyToReturn: likely, staffConnect: staff };
        }
        switchView('success');
        fireConfetti();
        fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) }).catch(e => console.error(e));
    }

    function showGate() { document.getElementById('gateModal').classList.add('show'); }
    function hideGate() { document.getElementById('gateModal').classList.remove('show'); document.getElementById('adminPass').value = ""; }

    async function verifyAdmin() {
        const pass = document.getElementById('adminPass').value;
        const btn = document.getElementById('gateBtn'); btn.disabled = true; document.getElementById('gateLoader').style.display = "block";
        try {
            const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "verifyPassword", password: pass }) });
            const result = await res.json();
            if (result.success) { state.isAdmin = true; hideGate(); showToast("Access Granted"); document.getElementById('adminLoginBtn').textContent = "Admin Console"; switchView('settings'); } else { showToast("Incorrect Password", true); }
        } catch (e) { showToast("Error connecting", true); }
        finally { btn.disabled = false; document.getElementById('gateLoader').style.display = "none"; }
    }

    async function saveAdminSettings() {
        const config = { 
            Events: state.tempEvents.map(e => e.name).join(','), 
            MarketEvents: state.tempEvents.filter(e => e.isMarket).map(e => e.name).join(','), 
            HeaderImageURL: document.getElementById('setHeaderImg').value, 
            SurveyDescription: document.getElementById('setDesc').value 
        };
        state.questionKeys.forEach(key => { config['q-' + key] = document.getElementById('q-' + key).value; });
        const newPass = document.getElementById('setNewPass').value.trim();
        const btn = document.getElementById('saveConfigBtn'); btn.disabled = true; document.getElementById('saveLoader').style.display = "block";
        try {
            await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "updateConfig", config }) });
            if (newPass) await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "changePassword", newPassword: newPass }) });
            showToast("Settings Updated!"); await syncSheetData(); switchView('settings');
        } catch (e) { showToast("Save Failed", true); }
        finally { btn.disabled = false; document.getElementById('saveLoader').style.display = "none"; }
    }

    function renderDashboard() {
        const dash = document.getElementById('dashboard'); dash.innerHTML = "";
        state.responses.forEach(g => {
            const card = document.createElement('div'); card.className = "frosted card";
            const imgId = Math.abs((g.eventname||"").split('').reduce((a,b)=>a+b.charCodeAt(0),0)) % 1000;
            const img = g.imageurl || `https://picsum.photos/seed/${imgId}/600/400`;
            card.innerHTML = `<div class="card-header"><img src="${img}" class="card-img"></div>
                <div class="card-body">
                    <h3 style="margin:0 0 12px 0">${g.eventname}</h3>
                    <div style="margin-bottom:12px">
                        <span class="badge" style="background:var(--gradient-accent)">‚òÖ ${Number(g.rating || 0).toFixed(1)}</span>
                        <span class="badge">${g.surveys || 0} Surveys</span>
                    </div>
                    <div style="font-size:0.7rem; color:var(--text-muted); margin-bottom:15px; display:flex; flex-wrap:wrap; gap:8px;">
                        <span>üë§ Attendance: ${g.attendance || "N/A"}</span>
                        <span>üè∑Ô∏è Team: ${g.hostingteam || "CAB"}</span>
                    </div>
                    <p style="font-size:0.9rem; color:#b0b0b0; line-height:1.6;">${g.summary || "Henry AI summary pending..."}</p>
                </div>`;
            dash.appendChild(card);
        });
    }

    function showToast(msg, isError = false) { 
        const t = document.getElementById('toast'); 
        t.textContent = msg; 
        t.style.background = isError ? 'var(--gradient-fire)' : 'var(--gradient-success)';
        t.style.display = 'block'; 
        setTimeout(() => t.style.display = 'none', 3500); 
    }
    window.onload = init;
</script>
</body>
</html>
