<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Event Survey Dashboard ‚Äî Frosted</title>

<style>
:root{
  --bg-img: url('https://i.imgur.com/hwef1LY.jpeg');
  --glass-surface: rgba(0,0,0,0.65);   /* darker for stronger frost */
  --glass-border: rgba(255,255,255,0.12);
  --glass-strong-border: rgba(255,255,255,0.2);
  --text: #ffffff;
  --text-muted: #d6d6d6;
  --text-dim: #bfbfbf;
  --focus: #9c7bd9;
  --radius-lg: 18px;
  --radius-md: 12px;
  --glass-blur: 28px;                  /* stronger blur */
  --glass-blur-strong: 36px;
}

* { box-sizing: border-box; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
html,body{ height:100%; }
body{
  margin:0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  color:var(--text);
  background: linear-gradient(180deg, rgba(0,0,0,0.18), rgba(0,0,0,0.36)), var(--bg-img) center/cover no-repeat fixed;
  padding-bottom:64px;
  opacity:0;
  animation:fadeIn 600ms ease forwards;
}
@keyframes fadeIn{ to { opacity: 1 } }

/* frosted glass */
.glass {
  background: rgba(0,0,0,0.55); /* base density */
  border-radius: var(--radius-md);
  border: 1px solid var(--glass-border);
  backdrop-filter: blur(var(--glass-blur)) saturate(200%);
  -webkit-backdrop-filter: blur(var(--glass-blur)) saturate(200%);
  box-shadow: 0 6px 18px rgba(0,0,0,0.6),
              inset 0 1px 0 rgba(255,255,255,0.05);
  position: relative;
  overflow: hidden;
}
.glass::before {
  content: "";
  position: absolute;
  inset: 0;
  background: rgba(0,0,0,0.25); /* tint overlay */
  mix-blend-mode: multiply;
  pointer-events: none;
}

/* header */
.topbar-container { position: fixed; top: 0; left: 0; width: 100%; z-index: 30; padding: 14px 18px 8px; }
.topbar{
  display:flex; justify-content:space-between; align-items:center;
  padding: 10px 14px; border-radius: 20px;
  background: rgba(0,0,0,0.45);
  backdrop-filter: blur(var(--glass-blur-strong)) saturate(180%);
  -webkit-backdrop-filter: blur(var(--glass-blur-strong)) saturate(180%);
  border: 1px solid rgba(255,255,255,0.15);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  max-width: 1200px; margin: 0 auto;
}
.topbar-left{ display:flex; align-items:center; gap:12px; }
.topbar-left img{
  height:44px; width:auto;
  filter: drop-shadow(0 3px 8px rgba(0,0,0,0.56));
  border-radius:8px;
  background: rgba(255,255,255,0.02);
  padding:4px;
}
.title{
  font-size:1.22rem; font-weight:600; letter-spacing:-0.01em; color:var(--text);
  line-height:1; text-shadow: 0 1px 0 rgba(0,0,0,0.45);
}
.topbar-controls{ display:flex; gap:12px; align-items:center }
input[type="text"], select {
  border: none; padding:.52rem .9rem; font-size:.96rem; border-radius:12px;
  background: rgba(0,0,0,0.3); min-height:38px; color:var(--text); outline:none;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.01); border: 1px solid rgba(255,255,255,0.1);
  backdrop-filter: blur(16px) saturate(180%); -webkit-backdrop-filter: blur(16px) saturate(180%);
}
input::placeholder{ color: var(--text-dim); opacity:0.95; }
select {
  -webkit-appearance: none; -moz-appearance: none; appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' width='18' height='18' fill='%23c9c9c9'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
  background-repeat: no-repeat; background-position: right 10px center; background-size: 1rem; padding-right: 2.2rem;
}
input:focus, select:focus, button:focus {
  box-shadow: 0 0 0 6px color-mix(in oklab, var(--focus) 14%, transparent), inset 0 0 0 1px var(--focus);
}

/* grid */
#dashboard{
  display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 1.25rem; padding: 20px; max-width: 1200px; margin: 100px auto 80px;
}
.card{
  padding: 16px; border-radius: var(--radius-lg);
  transition: transform .18s ease, box-shadow .18s ease; cursor: default;
  min-height: 110px; display:flex; flex-direction:column; gap:8px;
}
.card:hover{ transform: translateY(-6px); box-shadow: 0 12px 24px rgba(0,0,0,0.65); }
.card img.header { width:100%; max-height:160px; object-fit:cover; border-radius:12px; margin-bottom:10px; }
.card h2{ font-size:1.05rem; margin:0; font-weight:600; color:var(--text) }
.rating{ font-size:1.2rem; font-weight:700; color:#ffcb45; letter-spacing:0.02em }
.attendance{ font-size:1.05rem; font-weight:700; color:#fff }
.resp-count{ font-size:.82rem; color:var(--text-dim) }
.summary{ font-style:italic; font-size:.9rem; color:var(--text-muted); margin-top:4px }
.actions{ display:flex; gap:8px; margin-top:auto; flex-wrap:wrap }
.btn{
  padding:.5rem .85rem; font-size:.86rem; border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.12); background: rgba(0,0,0,0.35);
  cursor:pointer; color:var(--text);
  box-shadow: 0 2px 8px rgba(0,0,0,0.45);
}
.btn:hover{ transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.6); }

/* modal */
.modal{ position:fixed; inset:0; width:100%; height:100%; display:none; z-index:100; justify-content:center; align-items:flex-start; padding:48px 20px; }
.modal.show{ display:flex }
.modal-backdrop{ position:fixed; inset:0; background:rgba(6,8,12,0.6); backdrop-filter: blur(12px); }
.modal-content{
  position:relative; width:min(92vw, 980px); max-height:calc(100vh - 8rem); overflow:auto;
  border-radius: calc(var(--radius-lg) + 4px); padding: 18px; margin-top: 20px;
  border: 1px solid rgba(255,255,255,0.3); background: rgba(0,0,0,0.45);
  backdrop-filter: blur(var(--glass-blur-strong)) saturate(180%);
  -webkit-backdrop-filter: blur(var(--glass-blur-strong)) saturate(180%);
  box-shadow: 0 20px 60px rgba(0,0,0,0.7);
}
.close-btn{ margin-left:auto;margin-bottom:12px;padding:.5rem .9rem;border:none;border-radius:10px; background:rgba(0,0,0,0.35); color:var(--text); cursor:pointer; border:1px solid rgba(255,255,255,0.15); }
.response-card{ background: rgba(0,0,0,0.4); padding:12px 14px;border-radius:12px;margin-bottom:12px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 8px 24px rgba(0,0,0,0.55); line-height:1.45; }
.qa{ margin-bottom:.6rem }
.qa .label{ font-weight:700; font-size:.9rem; color:#ececec }
.qa .value{ font-size:1rem; color:#ffffff; margin-left:.25rem }

/* responsive */
@media (max-width: 640px){
  .topbar-container { padding: 12px 10px; }
  .topbar{ padding:10px; gap:10px; }
  .title{ font-size:1.05rem }
  #dashboard{ grid-template-columns: 1fr; padding:12px; gap:12px; margin: 90px auto 80px; }
  .modal{ padding: 18px 10px; align-items:flex-end }
  .modal-content{ width:100%; max-height: calc(100vh - 3.5rem); margin-top: 0; padding: 12px }
  .card{ padding:12px }
}
</style>
</head>
<body>
<div class="topbar-container">
  <div class="topbar">
    <div class="topbar-left">
      <img src="https://i.imgur.com/oqrmQSC.png" alt="CAB Logo">
      <div class="title">Event Survey Dashboard</div>
    </div>
    <div class="topbar-controls">
      <input id="search" type="text" placeholder="Search event‚Ä¶" autocomplete="off" />
      <select id="sortMode">
        <option value="rating">‚≠ê Rating</option>
        <option value="az">üî§ A‚ÄìZ</option>
        <option value="recent">üïí Recent</option>
        <option value="attendance">üë• Attendance</option>
      </select>
    </div>
  </div>
</div>

<div id="dashboard"></div>

<!-- modal for responses -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="modal-backdrop" data-close="backdrop"></div>
  <div class="modal-content">
    <button id="closeBtn" class="close-btn">Close</button>
    <h3 id="modalTitle">Responses</h3>
    <div id="modalBody"></div>
  </div>
</div>

<script>
/* Config */
const sheetID="1CqmQKvOkcLFV8XyzFrjK4H85skJCwRgSEwiP8j_6pMM";
const RAW_SHEET="Survey Responses",OVW_SHEET="Response overview";
const stars=n=>"‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ".slice(0,Math.round(n))+"‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ".slice(0,5-Math.round(n));

/* Data holders */
let ratingMap={},briefMap={},surveysMap={},imageMap={},attendanceMap={},groups={};
const keyEvent=n=>String(n||"").trim();

/* DOM helper */
function el(tag,attrs={},children=[]){
  const node=document.createElement(tag);
  for(const[k,v]of Object.entries(attrs)){
    if(k==='text')node.textContent=v;
    else if(k==='html')node.innerHTML=v;
    else node.setAttribute(k,v);
  }
  [].concat(children).forEach(c=>c&&node.appendChild(c));
  return node;
}

/* fetch with retry */
async function fetchSheet(name,tries=2){
  const url=`https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(name)}`;
  for(let i=0;i<tries;i++){
    try{
      const res=await fetch(url,{cache:'no-store'});
      const raw=await res.text();
      return JSON.parse(raw.substring(47,raw.length-2));
    }catch(err){
      if(i===tries-1) throw err;
      await new Promise(r=>setTimeout(r, 400*(i+1)));
    }
  }
}

/* load data */
(async()=>{
  const [overview,raw]=await Promise.all([fetchSheet(OVW_SHEET),fetchSheet(RAW_SHEET)]);
  overview.table.rows.forEach(r=>{
    const row=overview.table.cols.reduce((o,c,i)=>{o[c.label]=r.c[i]?r.c[i].v:"";return o},{});
    if(row["Event Name"]){
      ratingMap[row["Event Name"]]=+row["Overall Rating"]||0;
      briefMap[row["Event Name"]]=row["General Thoughts"]||"";
      imageMap[row["Event Name"]]=row["Header Image"]||"";
      surveysMap[row["Event Name"]]=+row["Total Surveys"]||0;
      attendanceMap[row["Event Name"]]=+row["Attendance"]||0;
    }
  });
  const hdr=raw.table.cols.map(c=>c.label);
  raw.table.rows.forEach(r=>{
    const row=hdr.reduce((o,h,i)=>{o[h]=r.c[i]?r.c[i].v:"";return o},{});
    const ev=keyEvent(row["Which Student Market Would You Like To Survey?"]||row["Which Event Would You Like To Survey?"]||"Unknown Event");
    (groups[ev]=groups[ev]||[]).push(row);
  });
  render();
})();

/* render cards */
function maxDate(rows){return Math.max(...rows.map(r=>new Date(r.Timestamp||0).getTime()||0),0);}
function render(filter="",sort="rating"){
  const dash=document.getElementById("dashboard");dash.innerHTML="";
  let entries=Object.entries(groups);
  if(sort==="rating")entries.sort((a,b)=>(ratingMap[b[0]]||0)-(ratingMap[a[0]]||0));
  if(sort==="az")entries.sort((a,b)=>a[0].localeCompare(b[0]));
  if(sort==="recent")entries.sort((a,b)=>(maxDate(b[1])-maxDate(a[1])));
  if(sort==="attendance")entries.sort((a,b)=>(attendanceMap[b[0]]||0)-(attendanceMap[a[0]]||0));

  for(const[evt,resps]of entries){
    if(filter&&!evt.toLowerCase().includes(filter.toLowerCase()))continue;
    const card=el("div",{class:"card glass"});
    const img=imageMap[evt];if(img)card.appendChild(el('img',{src:img,alt:evt+" header",class:"header"}));
    const rt=ratingMap[evt]||0,sum=briefMap[evt]||"",cnt=surveysMap[evt]||(resps?.length||0),att=attendanceMap[evt]||0;
    const h2=el('h2',{text:evt});
    const ratingDiv=el('div',{class:'rating',html:rt?`${stars(rt)} (${rt.toFixed(1)}/5.0)`:""});
    const attendanceDiv=el('div',{class:'attendance',html:`<b>Attendance:</b> ${att||"N/A"}`});
    const respCount=el('div',{class:'resp-count',text:`${cnt} survey${cnt!==1?"s":""}`});
    const summary=el('div',{class:'summary',text:sum||"No summary available."});
    const actions=el('div',{class:'actions'},[
      el('button',{class:'btn view-btn',text:'View Responses'}),
      el('button',{class:'btn pdf-btn',text:'Download PDF'})
    ]);
    card.append(h2,ratingDiv,attendanceDiv,respCount,summary,actions);dash.appendChild(card);
    card.querySelector('.view-btn').onclick=()=>openModal(evt,resps);
    card.querySelector('.pdf-btn').onclick=()=>downloadPDF(evt,rt,sum,img,att,resps);
  }
}

/* modal */
function openModal(evt,resps){
  document.getElementById('modalTitle').textContent=`Responses ‚Äî ${evt}`;
  const body=document.getElementById('modalBody');body.innerHTML="";
  resps.forEach((row,j)=>{
    const wrap=document.createElement('div');wrap.className="response-card";
    const h=document.createElement('h4');h.textContent=`Response #${j+1}`;wrap.appendChild(h);
    Object.entries(row).forEach(([lab,val])=>{
      if(!val||/Timestamp|Student ID/i.test(lab))return;
      const qa=document.createElement('div');qa.className="qa";
      const labEl=document.createElement('div');labEl.className="label";labEl.textContent=lab;
      const valEl=document.createElement('div');valEl.className="value";valEl.textContent=val;
      qa.append(labEl,valEl);wrap.appendChild(qa);
    });
    body.appendChild(wrap);
  });
  document.getElementById('modal').classList.add('show');
}
document.getElementById('closeBtn').onclick=()=>document.getElementById('modal').classList.remove('show');
document.querySelector('.modal-backdrop').onclick=()=>document.getElementById('modal').classList.remove('show');

/* PDF export */
function downloadPDF(evt,rt,sum,img,att,resps){
  let html=`<html><head><meta charset="UTF-8"><title>${evt}</title><style>
  body{font-family:Arial,sans-serif;color:#000;}
  .header{display:flex;align-items:center;gap:12px;margin-bottom:16px;}
  .header img{max-height:100px;}
  h1{font-size:22px;margin:0 0 6px;}
  .rating{margin:6px 0 12px;}
  .summary{font-style:italic;margin:4px 0 18px;}
  .response{border:1px solid #ccc;border-radius:8px;padding:12px;margin:10px 0;}
  </style></head><body>`;
  html+=`<div class="header">`;if(img)html+=`<img src="${img}">`;html+=`<div><h1>${evt}</h1></div></div>`;
  if(rt)html+=`<div class="rating">${stars(rt)} (${rt.toFixed(1)}/5.0)</div>`;
  html+=`<div style="font-weight:700;"><b>Attendance:</b> ${att||"N/A"}</div>`;
  if(sum)html+=`<div class="summary">${sum}</div>`;
  resps.forEach((row,j)=>{const lines=[];Object.entries(row).forEach(([lab,val])=>{if(!val||/Timestamp|Student ID/i.test(lab))return;lines.push(`<div><b>${lab}:</b> ${val}</div>`);});if(lines.length)html+=`<div class="response"><h3>Response #${j+1}</h3>${lines.join("")}</div>`;});
  html+=`</body></html>`;
  const win=window.open("");win.document.write(html);win.document.close();win.print();
}

/* search/sort */
document.getElementById('search').addEventListener('input',e=>render(e.target.value,document.getElementById('sortMode').value));
document.getElementById('sortMode').addEventListener('change',e=>render(document.getElementById('search').value,e.target.value));
</script>
</body>
</html>
