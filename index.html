<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>CAB Event Evaluation Responses</title>
  <style>
    @font-face {
      font-family: 'Thunder';
      src: url('Thunder-Regular.otf') format('opentype');
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: url('https://i.imgur.com/IYZzkfE.png') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      margin: 0;
      padding: 2rem;
    }
    .header-container { text-align: center; margin-bottom: 2.5rem; }
    h1 {
      font-family: 'Thunder', sans-serif;
      font-size: 2.2rem;
      color: #fff;
      backdrop-filter: blur(6px);
    }
    .header-subtitle {
      font-size: 1rem;
      color: #fff;
      font-style: italic;
      opacity: 0.9;
    }
    #search {
      display: block;
      margin: 2rem auto;
      padding: 0.8rem 1.2rem;
      font-size: 1.1rem;
      border: none;
      border-radius: 8px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      backdrop-filter: blur(10px);
      max-width: 900px;
    }
    #search::placeholder { color: #fff; opacity: 1; }
    details {
      background: rgba(0,0,0,0.65);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      margin-bottom: 1.5rem;
      backdrop-filter: blur(12px);
      overflow: hidden;
    }
    details[open] {
      background: rgba(0,0,0,0.75);
      border: 1px solid rgba(255,255,255,0.15);
      backdrop-filter: blur(20px);
    }
    summary {
      cursor: pointer;
      padding: 1.2rem 1.6rem;
      font-size: 1.05rem;
      font-weight: 600;
      color: #fff;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .summary-left { display: flex; align-items: center; gap: 0.75rem; }
    .event-label { font-size: 1.1rem; font-weight: 600; color: #fff; }
    .dropdown { font-size: 1rem; color: #ccc; transition: transform 0.3s ease; }
    details[open] summary .dropdown { transform: rotate(180deg); }
    .stars { font-size: 0.95rem; color: #ccc; }
    .overview-text {
      font-size: 0.9rem;
      color: #aaa;
      margin: 0.4rem 1.6rem 1rem;
      font-style: italic;
    }
    .response-block { padding: 1rem 1.6rem; border-top: 1px solid rgba(255,255,255,0.15); }
    .response {
      margin-bottom: 1.8rem;
      padding: 1.2rem;
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      backdrop-filter: blur(10px);
    }
    .review-title {
      font-weight: 600;
      font-size: 1.1rem;
      margin-bottom: 1rem;
      color: #fff;
      border-bottom: 1px solid rgba(255,255,255,0.12);
      padding-bottom: 0.5rem;
    }
    .field { margin-bottom: 1.2rem; padding-bottom: 1.2rem; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .label { font-weight: 500; font-size: 0.85rem; color: #ccc; margin-bottom: 0.2rem; }
    .value { font-size: 1.05rem; color: #fff; line-height: 1.4; }
    #topBtn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 40px;
      height: 40px;
      background: rgba(0,0,0,0.6);
      color: white;
      border: 1px solid #555;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      z-index: 999;
      backdrop-filter: blur(5px);
    }
  </style>
</head>
<body>
  <div class="header-container">
    <img src="https://i.imgur.com/oqrmQSC.png" alt="CAB Logo" style="width:100px; margin-bottom:-0.3rem; margin-top:0.5rem;" />
    <h1>Event Evaluation Responses</h1>
    <p class="header-subtitle">Anonymous student feedback collected live from each CAB event</p>
  </div>
  <input type="text" id="search" placeholder="Search for an event…" />
  <div id="dash"></div>
  <button id="topBtn">↑</button>

  <script>
    const sheetID = "1CqmQKvOkcLFV8XyzFrjK4H85skJCwRgSEwiP8j_6pMM";
    const RAW_SHEET = "Survey Responses";
    const OVW_SHEET = "Response overview";

    async function fetchSheet(sheetName) {
      const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
      const raw = await fetch(url).then(r => r.text());
      return JSON.parse(raw.substring(47, raw.length - 2));
    }

    function extractEvent(row) {
      return row["Which Event Would You Like To Survey?"] ||
             row["Which Student Market Would You Like To Survey?"] ||
             row["Event Name"] || "Unknown Event";
    }

    function stars(n) {
      if (!n) return "";
      const s = Math.round(n);
      return "★★★★★".slice(0, s) + "☆☆☆☆☆".slice(0, 5 - s);
    }

    function createPDFButton(eventName, detailsEl, ratingMap, briefMap) {
      const btn = document.createElement("button");
      btn.textContent = "Download PDF";
      btn.style.cssText = "margin:1rem 1.6rem; padding:0.6rem 1rem; font-size:0.9rem; border:none; border-radius:6px; background:rgba(255,255,255,0.12); color:#fff; cursor:pointer; backdrop-filter:blur(5px);";
      btn.addEventListener("click", () => {
        const responsesHTML = detailsEl.querySelector(".response-block")?.innerHTML || "";
        const rating = ratingMap[eventName];
        const thoughts = briefMap[eventName];
        const html = `
          <html><head><title>${eventName}</title><style>
          body { font-family: Arial; padding: 2rem; color: #000; }
          .response { margin-bottom: 1rem; border: 1px solid #ccc; padding: 1rem; border-radius: 8px; }
          .review-title { font-weight: bold; }
          .label { font-weight: bold; font-size: 0.85rem; }
          .value { font-size: 1rem; }
          .summary-box { background: #f0f0f0; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
          .stars { color: #444; font-size: 0.95rem; }
          .thoughts { font-style: italic; color: #555; font-size: 0.85rem; }
          </style></head><body>
          <div class='summary-box'>
            <h2>${eventName}</h2>
            ${rating ? `<div class='stars'>${"★".repeat(Math.round(rating))}${"☆".repeat(5 - Math.round(rating))} (${rating.toFixed(1)}/5.0)</div>` : ""}
            ${thoughts ? `<div class='thoughts'>${thoughts}</div>` : ""}
          </div>
          ${responsesHTML}</body></html>`;
        const win = window.open("", "_blank");
        win.document.write(html);
        win.document.close();
        win.print();
      });
      return btn;
    }

    (async () => {
      const [overview, rawRes] = await Promise.all([fetchSheet(OVW_SHEET), fetchSheet(RAW_SHEET)]);
      const ratingMap = {}, briefMap = {}, groups = {};
      const ovwHeaders = overview.table.cols.map(c => c.label);
      overview.table.rows.forEach(r => {
        const row = ovwHeaders.reduce((acc, h, i) => (acc[h] = r.c[i]?.v || "", acc), {});
        if (row["Event Name"]) {
          ratingMap[row["Event Name"]] = +row["Overall Rating"];
          briefMap[row["Event Name"]] = row["General Thoughts"] || "";
        }
      });

      const rawHeaders = rawRes.table.cols.map(c => c.label);
      const rawRows = rawRes.table.rows.map(r =>
        rawHeaders.reduce((o, h, i) => (o[h] = r.c[i]?.v || "", o), {})
      );

      rawRows.forEach(r => {
        const event = extractEvent(r);
        if (!groups[event]) groups[event] = [];
        groups[event].push(r);
      });

      const dash = document.getElementById("dash");
      const searchInput = document.getElementById("search");

      function render(filter = "") {
        dash.innerHTML = "";
        Object.entries(groups).sort().forEach(([event, responses]) => {
          if (!event.toLowerCase().includes(filter.toLowerCase())) return;
          const det = document.createElement("details");
          const sum = document.createElement("summary");
          const rating = ratingMap[event];
          const overview = briefMap[event];
          sum.innerHTML = `<span class="summary-left"><span class="event-label">${event}</span><span class="dropdown">▼</span></span><span class="stars">${rating ? `${stars(rating)} (${rating.toFixed(1)}/5.0)` : ""}</span>`;
          det.appendChild(sum);
          if (overview) {
            const blurb = document.createElement("div");
            blurb.className = "overview-text";
            blurb.textContent = overview;
            det.appendChild(blurb);
          }
          const block = document.createElement("div");
          block.className = "response-block";
          responses.forEach((res, i) => {
            const div = document.createElement("div");
            div.className = "response";
            const title = document.createElement("div");
            title.className = "review-title";
            title.textContent = `Student Survey #${i + 1}`;
            div.appendChild(title);
            Object.entries(res).forEach(([label, val]) => {
              if (!val || /Timestamp|Student ID|Which Event|Which Student Market/.test(label)) return;
              const field = document.createElement("div");
              field.className = "field";
              field.innerHTML = `<div class="label">${label}</div><div class="value">${val}</div>`;
              div.appendChild(field);
            });
            block.appendChild(div);
          });
          det.appendChild(block);
          det.appendChild(createPDFButton(event, det, ratingMap, briefMap));
          dash.appendChild(det);
        });
      }

      render();
      searchInput.addEventListener("input", () => render(searchInput.value));
    })();

    document.getElementById("topBtn").addEventListener("click", () =>
      window.scrollTo({ top: 0, behavior: "smooth" })
    );
  </script>
</body>
</html>
