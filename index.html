<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CAB Event Survey Responses</title>
  <style>
    @font-face {
      font-family: 'Thunder';
      src: url('Thunder-Regular.otf') format('opentype');
    }
    body {
      background: url('https://i.imgur.com/IYZzkfE.png') no-repeat center center fixed;
      background-size: cover;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 2rem;
    }
    .header-container {
      text-align: center;
      margin-bottom: 2rem;
    }
    h1 {
      font-family: 'Thunder', sans-serif;
      font-size: 2.5rem;
      margin: 0.5rem 0;
    }
    .header-subtitle {
      font-style: italic;
      color: #fff;
    }
    #search {
      display: block;
      margin: 1rem auto 1.5rem;
      padding: 0.4rem 0.75rem;
      font-size: 0.95rem;
      max-width: 400px;
      width: 100%;
      border-radius: 8px;
      border: none;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      box-shadow: 0 0 6px rgba(255, 255, 255, 0.1);
      font-family: inherit;
      text-align: center;
    }
    #search::placeholder {
      color: #eee;
      opacity: 1;
    }
    summary::marker { display: none; }
    details {
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      margin-bottom: 1.2rem;
      overflow: hidden;
    }
    summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      padding: 1rem 1.2rem;
    }
    .summary-left {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .event-label {
      font-weight: 600;
    }
    .dropdown {
      transition: transform 0.3s ease;
    }
    details[open] .dropdown {
      transform: rotate(180deg);
    }
    .stars {
      font-size: 0.9rem;
      color: #ccc;
      white-space: nowrap;
    }
    .response-block {
      padding: 1rem 1.2rem;
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    .response {
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 8px;
    }
    .review-title {
      font-weight: bold;
      margin-bottom: 0.75rem;
    }
    .field {
      margin-bottom: 1rem;
    }
    .label {
      font-weight: 500;
      font-size: 0.85rem;
      color: #ccc;
    }
    .value {
      font-size: 1rem;
      color: #fff;
    }
    .overview-text {
      margin: 0 1.2rem 1rem;
      font-style: italic;
      color: #ccc;
      font-size: 0.9rem;
    }
    .pdf-btn {
      margin: 1rem 1.2rem;
      padding: 0.4rem 0.75rem;
      font-size: 0.85rem;
      background: rgba(255,255,255,0.12);
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="header-container">
    <img src="https://i.imgur.com/oqrmQSC.png" alt="CAB Logo" style="width:100px;">
    <h1>Event Survey Responses</h1>
    <p class="header-subtitle">Anonymous student feedback collected live from each CAB event</p>
  </div>

  <div style="text-align: center;">
    <input type="text" id="search" placeholder="Search for an event..." />
  </div>

  <div id="dash"></div>

  <script>
    const sheetID = "1CqmQKvOkcLFV8XyzFrjK4H85skJCwRgSEwiP8j_6pMM";
    const RAW_SHEET = "Survey Responses";
    const OVW_SHEET = "Response overview";

    async function fetchSheet(name){
      const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(name)}`;
      const raw = await fetch(url).then(r => r.text());
      return JSON.parse(raw.substring(47, raw.length - 2));
    }

    function extractEvent(r){
      return r["Which Event Would You Like To Survey?"] || r["Which Student Market Would You Like To Survey?"] || r["Event Name"] || "Unknown Event";
    }

    function stars(n){
      if (!n) return "";
      const s = Math.round(n);
      return "★★★★★".slice(0, s) + "☆☆☆☆☆".slice(0, 5 - s);
    }

    function createPDFButton(eventName, detailsEl, ratingMap, briefMap){
      const btn = document.createElement("button");
      btn.textContent = "Download PDF";
      btn.className = "pdf-btn";
      btn.addEventListener("click", () => {
        const clone = detailsEl.cloneNode(true);
        const responsesHTML = clone.querySelector(".response-block")?.innerHTML || "";
        const rating = ratingMap[eventName];
        const thoughts = briefMap[eventName];
        const html = `
          <html><head><title>${eventName}</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 2rem; color: #000; }
            .response { border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; border-radius: 8px; }
            .review-title { font-weight: bold; margin-bottom: 0.5rem; }
            .label { font-weight: bold; font-size: 0.85rem; margin-bottom: 0.2rem; }
            .value { font-size: 1rem; margin-bottom: 0.6rem; }
            .summary-box { background: #f0f0f0; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; }
            .stars { font-size: 0.95rem; color: #444; }
            .thoughts { font-style: italic; font-size: 0.9rem; color: #555; margin-top: 0.3rem; }
          </style></head><body>
          <div class="summary-box"><h2>${eventName}</h2>
          ${rating ? `<div class="stars">${"★".repeat(Math.round(rating))}${"☆".repeat(5 - Math.round(rating))} (${rating.toFixed(1)}/5.0)</div>` : ""}
          ${thoughts ? `<div class="thoughts">${thoughts}</div>` : ""}
          </div>${responsesHTML}</body></html>
        `;
        const win = window.open("", "_blank");
        win.document.write(html);
        win.document.close();
        win.focus();
        win.print();
      });
      return btn;
    }

    (async () => {
      const [overview, rawRes] = await Promise.all([fetchSheet(OVW_SHEET), fetchSheet(RAW_SHEET)]);

      const ratingMap = {}, briefMap = {};
      const ovwHeaders = overview.table.cols.map(c => c.label);
      overview.table.rows.forEach(r => {
        const row = ovwHeaders.reduce((o, h, i) => {
          o[h] = r.c[i] ? r.c[i].v : "";
          return o;
        }, {});
        if (row["Event Name"]) {
          ratingMap[row["Event Name"]] = Number(row["Overall Rating"]);
          briefMap[row["Event Name"]] = row["General Thoughts"] || "";
        }
      });

      const rawHeaders = rawRes.table.cols.map(c => c.label);
      const rawRows = rawRes.table.rows.map(r =>
        rawHeaders.reduce((o, h, i) => {
          o[h] = r.c[i] ? r.c[i].v : "";
          return o;
        }, {})
      );

      const groups = {};
      rawRows.forEach(r => {
        const event = extractEvent(r);
        if (!groups[event]) groups[event] = [];
        groups[event].push(r);
      });

      const dash = document.getElementById("dash");
      const searchInput = document.getElementById("search");

      function render(filter = "") {
        dash.innerHTML = "";
        let hasResults = false;
        Object.entries(groups).sort((a, b) => b[0].localeCompare(a[0])).forEach(([event, responses]) => {
          if (!event.toLowerCase().includes(filter.toLowerCase())) return;
          hasResults = true;
          const det = document.createElement("details");
          const sum = document.createElement("summary");
          const rating = ratingMap[event];
          const overview = briefMap[event];
          sum.innerHTML = `<span class="summary-left"><span class="event-label">${event} (${responses.length} responses)</span><span class="dropdown">▼</span></span><span class="stars">${rating ? `${stars(rating)} (${rating.toFixed(1)}/5.0)` : ""}</span>`;
          det.appendChild(sum);
          if (overview) {
            const desc = document.createElement("div");
            desc.className = "overview-text";
            desc.textContent = overview;
            det.appendChild(desc);
          }
          const block = document.createElement("div");
          block.className = "response-block";
          responses.forEach((res, i) => {
            const div = document.createElement("div");
            div.className = "response";
            const title = document.createElement("div");
            title.className = "review-title";
            title.textContent = `Student Survey #${i + 1}`;
            div.appendChild(title);
            Object.entries(res).forEach(([label, val]) => {
              if (!val || label.includes("Timestamp") || label.includes("Student ID") || label.includes("Which Event") || label.includes("Which Student Market")) return;
              const field = document.createElement("div");
              field.className = "field";
              field.innerHTML = `<div class="label">${label}</div><div class="value">${val}</div>`;
              div.appendChild(field);
            });
            block.appendChild(div);
          });
          det.appendChild(block);
          det.appendChild(createPDFButton(event, det, ratingMap, briefMap));
          dash.appendChild(det);
        });

        if (!hasResults) {
          dash.innerHTML = "<p style='text-align:center; color: white; font-size: 1rem;'>No matching events found. Try another search.</p>";
        }
      }

      render();
      searchInput.addEventListener("input", () => render(searchInput.value));
    })();
  </script>
</body>
</html>
