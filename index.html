<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Event Survey Dashboard</title>

  <style>
    :root{
      --glass-bg: rgba(0,0,0,.55);
      --glass-brd: rgba(255,255,255,.12);
      --text-muted: #ccc;
      --text-dim: #aaa;
      --focus: #9c7bd9; /* GCU-ish purple */
    }

    * { box-sizing: border-box }
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:url('https://i.imgur.com/dMhBqOj.jpeg') center/cover no-repeat fixed;
      color:#fff;
      opacity:0;
      animation:fadeIn 1.2s ease forwards;
    }
    @keyframes fadeIn{to{opacity:1}}

    @media (prefers-contrast: more){
      :root{ --glass-bg: rgba(0,0,0,.75); --glass-brd: rgba(255,255,255,.25) }
    }
    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important }
    }

    /* Top bar */
    .topbar{
      position:sticky;top:0;display:flex;justify-content:space-between;align-items:center;
      padding:1rem 2rem;background:rgba(0,0,0,.6);backdrop-filter:blur(10px);z-index:10;
      border-bottom:1px solid var(--glass-brd);
    }
    .topbar-left{display:flex;align-items:center;gap:1rem}
    .topbar-left img{height:50px}
    .title{font-size:1.8rem;font-weight:bold}

    .topbar-controls{display:flex;gap:1rem;align-items:center}
    #search,#sortMode{
      width:260px;padding:.55rem 1rem;font-size:1rem;border:none;border-radius:8px;
      background:rgba(255,255,255,.2);color:#fff;
    }
    #search::placeholder{color:#fff;opacity:.85}
    #sortMode{
      appearance:none;padding:.55rem 2.25rem .55rem 1rem;
      background-image:url("data:image/svg+xml,%3Csvg fill='white' viewBox='0 0 24 24' width='18' height='18' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat:no-repeat;background-position:right .6rem center;background-size:1rem;
    }

    input,select,button{ outline: none }
    input:focus,select:focus,button:focus{
      box-shadow:0 0 0 3px color-mix(in oklab, var(--focus) 50%, transparent);
    }

    /* Grid */
    #dashboard{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
      gap:1.5rem;padding:2rem;
    }
    .card{
      background:var(--glass-bg);border:1px solid var(--glass-brd);border-radius:12px;
      padding:1.2rem;backdrop-filter:blur(8px);
    }
    .card h2{font-size:1.2rem;margin:.4rem 0}
    .rating{font-size:1.4rem;font-weight:bold;color:#ffc107}
    .resp-count{font-size:.8rem;color:var(--text-dim);margin-bottom:.8rem}
    .summary{font-style:italic;font-size:.9rem;color:var(--text-muted);margin-bottom:1rem}

    .actions{display:flex;flex-wrap:wrap;gap:.5rem}
    .btn{
      padding:.45rem .9rem;font-size:.85rem;background:rgba(255,255,255,.15);
      border:none;border-radius:6px;color:#fff;cursor:pointer;transition:transform .2s ease;
    }
    .btn:hover{transform:scale(1.05)}

    /* Banners */
    .banner{margin:1rem 2rem;padding:.8rem 1rem;border-radius:10px}
    .banner.info{background:rgba(255,255,255,.12);border:1px solid var(--glass-brd)}
    .banner.error{background:rgba(255,0,0,.15);border:1px solid rgba(255,0,0,.35)}

    /* Modal (scrollable content) */
    .modal{ position:fixed; inset:0; width:100%; height:100%; display:none; z-index:100; justify-content:center; align-items:flex-start; padding:3rem 1rem; }
    .modal.show{ display:flex; }
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.85); backdrop-filter:blur(5px) }
    .modal-content{
      position:relative; width:min(92vw, 800px); background:rgba(255,255,255,.05); color:#fff;
      padding:2rem; border-radius:12px; border:1px solid var(--glass-brd);
      max-height:calc(100vh - 6rem); overflow:auto; -webkit-overflow-scrolling:touch;
    }
    .close-btn{
      margin-left:auto;margin-bottom:1rem;padding:.5rem 1rem;border:none;border-radius:6px;
      background:rgba(255,255,255,.2);color:#fff;cursor:pointer;
    }
    .response-card{
      background:rgba(255,255,255,.05);padding:1.5rem 1.8rem;border-radius:10px;
      margin-bottom:2rem;border:1px solid rgba(255,255,255,.15);line-height:1.6;
    }
    .qa{margin-bottom:1rem}
    .qa .label{font-weight:600;font-size:.9rem;margin-bottom:.2rem;color:#ddd}
    .qa .value{font-size:1rem;color:#fff;margin-left:.5rem}

    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    @media(max-width:640px){
      .topbar{flex-direction:column;align-items:flex-start;gap:.8rem;padding:.8rem 1rem}
      .title{font-size:1.4rem}
      .topbar-controls{width:100%;flex-direction:column;gap:.6rem}
      #search,#sortMode{width:100%;font-size:.88rem;padding:.55rem .95rem}
      #sortMode{background-position:right .75rem center;background-size:1rem}
      #dashboard{grid-template-columns:1fr;padding:1.2rem;gap:1rem}
      .card{padding:1rem}.card h2{font-size:1.05rem}.rating{font-size:1.2rem}
      .modal{padding:1.5rem .75rem}
      .modal-content{width:100%;max-height:calc(100vh - 3rem);padding:1.2rem}
      .response-card{padding:1rem 1.2rem;font-size:.95rem}
      .qa .label{font-size:.85rem}.qa .value{font-size:.95rem}
    }
  </style>
</head>

<body>
  <!-- Live banner -->
  <div id="banner" class="banner info" role="status" aria-live="polite" hidden>Loading responses‚Ä¶</div>

  <!-- Top bar -->
  <div class="topbar" role="region" aria-label="Toolbar">
    <div class="topbar-left">
      <img src="https://i.imgur.com/oqrmQSC.png" alt="CAB Logo" aria-hidden="true">
      <div class="title">Event Survey Dashboard</div>
    </div>
    <div class="topbar-controls">
      <label class="sr-only" for="search">Search event</label>
      <input id="search" type="text" placeholder="Search event‚Ä¶" autocomplete="off" />
      <label class="sr-only" for="sortMode">Sort</label>
      <select id="sortMode" aria-label="Sort events">
        <option value="rating">‚≠ê Rating</option>
        <option value="az">üî§ A‚ÄìZ</option>
        <option value="recent">üïí Recent</option>
      </select>
    </div>
  </div>

  <!-- Event grid -->
  <div id="dashboard"></div>

  <!-- Modal -->
  <div id="modal" class="modal" aria-hidden="true" aria-labelledby="modalTitle">
    <div class="modal-backdrop" data-close="backdrop"></div>
    <div class="modal-content" role="dialog" aria-modal="true">
      <button id="closeBtn" class="close-btn" aria-label="Close dialog">Close</button>
      <h3 id="modalTitle" class="sr-only">Responses</h3>
      <div id="modalBody"></div>
    </div>
  </div>

  <!-- Main logic -->
  <script>
    /* Config */
    const sheetID  = "1CqmQKvOkcLFV8XyzFrjK4H85skJCwRgSEwiP8j_6pMM";
    const RAW_SHEET = "Survey Responses";
    const OVW_SHEET = "Response overview";
    const stars = n => "‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ".slice(0,Math.round(n))+"‚òÜ‚òÜ‚òÜ‚òÜ‚òÜ".slice(0,5-Math.round(n));

    /* Data holders */
    let ratingMap={},briefMap={},groups={};

    /* DOM helpers */
    function el(tag, attrs={}, children=[]) {
      const node = document.createElement(tag);
      for (const [k,v] of Object.entries(attrs)){
        if (k === 'text') node.textContent = v;
        else if (k === 'html') node.innerHTML = v;
        else node.setAttribute(k,v);
      }
      for (const c of [].concat(children)) if (c) node.appendChild(c);
      return node;
    }
    function safeText(text){ const s = document.createElement('span'); s.textContent = String(text ?? ''); return s; }

    // Find a field by exact label OR regex (tolerant to wording/spacing)
    function findField(row, matcher){
      if(typeof matcher === 'string'){
        if(row[matcher]) return { key: matcher, val: row[matcher] };
        const k = Object.keys(row).find(k=>k && k.trim().toLowerCase()===matcher.trim().toLowerCase());
        return k ? { key:k, val: row[k] } : { key: matcher, val: '' };
      } else { // regex
        const k = Object.keys(row).find(k=> matcher.test(k));
        return k ? { key:k, val: row[k] } : { key: matcher.source, val: '' };
      }
    }

    /* Fetch helper with banner + basic retry */
    async function fetchSheet(name, tries=2){
      const url=`https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(name)}`;
      for(let i=0;i<tries;i++){
        try{
          const res = await fetch(url, { cache: 'no-store' });
          const raw = await res.text();
          return JSON.parse(raw.substring(47,raw.length-2));
        }catch(err){
          if(i===tries-1) throw err;
          await new Promise(r=>setTimeout(r, 400*(i+1)));
        }
      }
    }

    function showBanner(kind, text){
      const b = document.getElementById('banner');
      b.className = `banner ${kind}`; b.textContent = text; b.hidden = false;
    }
    function hideBanner(){ document.getElementById('banner').hidden = true }

    /* Initial load */
    (async()=>{
      try{
        showBanner('info','Loading responses‚Ä¶');
        const [overview,raw] = await Promise.all([fetchSheet(OVW_SHEET),fetchSheet(RAW_SHEET)]);

        // Overall ratings + summary
        overview.table.rows.forEach(r=>{
          const row=overview.table.cols.reduce((o,c,i)=>{o[c.label]=r.c[i]?r.c[i].v:"";return o},{});
          if(row["Event Name"]){
            ratingMap[row["Event Name"]]= +row["Overall Rating"] || 0;
            briefMap[row["Event Name"]] = row["General Thoughts"]||"";
          }
        });

        // Individual responses
        const hdr=raw.table.cols.map(c=>c.label);
        raw.table.rows.forEach(r=>{
          const row=hdr.reduce((o,h,i)=>{o[h]=r.c[i]?r.c[i].v:"";return o},{});
          const evt=row["Which Student Market Would You Like To Survey?"]||
                    row["Which Event Would You Like To Survey?"]||
                    "Unknown Event";
          (groups[evt]=groups[evt]||[]).push(row);
        });

        render(); hideBanner();
      }catch(e){
        console.error(e);
        showBanner('error','Could not load data. Make sure both tabs are published to the web and accessible: "Response overview" and "Survey Responses".');
      }
    })();

    /* Render dashboard */
    function render(filter="",sort="rating"){
      const dash=document.getElementById("dashboard");
      dash.innerHTML="";
      let entries=Object.entries(groups);

      if(sort==="rating") entries.sort((a,b)=>(ratingMap[b[0]]||0)-(ratingMap[a[0]]||0));
      if(sort==="az") entries.sort((a,b)=>a[0].localeCompare(b[0]));
      if(sort==="recent") entries.sort((a,b)=> (maxDate(b[1]) - maxDate(a[1])) );

      for (const [evt,resps] of entries){
        if(!evt.toLowerCase().includes(filter.toLowerCase())) continue;
        const card=document.createElement("div");card.className="card";

        const rt = ratingMap[evt];
        const sum = briefMap[evt];
        const cnt = resps.length;

        const h2 = el('h2',{ text: evt });
        const ratingDiv = el('div',{ class:'rating', html: rt ? `${stars(rt)} (${rt.toFixed(1)}/5.0)` : ''});
        const respCount = el('div',{ class:'resp-count', text: `${cnt} response${cnt!==1?"s":""}`});
        const summary = el('div',{ class:'summary', text: sum||"No summary available."});

        const actions = el('div',{ class:'actions' },[
          el('button',{ class:'btn view-btn', 'aria-label':`View responses for ${evt}`, text:'View Responses' }),
          el('button',{ class:'btn pdf-btn', 'aria-label':`Download HTML for ${evt}`, text:'Download HTML' }),
          el('button',{ class:'btn csv-btn', 'aria-label':`Download CSV for ${evt}`, text:'Export CSV' })
        ]);

        card.append(h2,ratingDiv,respCount,summary,actions);
        dash.appendChild(card);

        card.querySelector('.view-btn').onclick=()=>openModal(evt,resps);
        card.querySelector('.pdf-btn').onclick=()=>downloadHTML(evt,rt,sum,resps);
        card.querySelector('.csv-btn').onclick=()=>downloadCSV(evt,resps);
      }
    }

    function maxDate(rows){
      const times = rows.map(r=> new Date(r.Timestamp || r.timestamp || 0).getTime() || 0);
      return Math.max(...times,0);
    }

    /* Modal controls */
    const modal = document.getElementById('modal');
    const modalBody = document.getElementById('modalBody');
    const closeBtn = document.getElementById('closeBtn');

    function openModal(evt,resps){
      modalBody.innerHTML = '';

      resps.forEach((row,j)=>{
        const wrap = el('div',{ class:'response-card' },[
          el('h4',{ text:`Response #${j+1}` })
        ]);

        const isMarket = !!row["Which Student Market Would You Like To Survey?"];

        // Order we want first, with tolerant matching for comments fields (K and R)
        const orderSpecs = isMarket ? [
          "Which Student Market Would You Like To Survey?",
          "How would you rate your overall experience at the Student Market?",
          "What did you enjoy most about this market?",
          "How satisfied were you with the variety of vendors?",
          "Did you make a purchase at the market?",
          "Was this your first time attending a CAB Student Market?",
          /Any additional comments or suggestions.*Student Markets team\?/i
        ] : [
          "Which Event Would You Like To Survey?",
          "How would you rate your overall experience at this event?",
          "Was this your first time attending a CAB event?",
          "How did you hear about this event?",
          "What was your favorite part of the event?",
          "What would you change or improve for next time?",
          "How likely are you to attend a CAB event again?",
          "Did any CAB Event Staff take the time to connect with you or talk to you during the event? (If so who?)",
          /Any additional comments or suggestions.*CAB team\?/i
        ];

        // Render ordered fields first
        const renderedKeys = new Set();
        for (const spec of orderSpecs){
          const { key, val } = findField(row, spec);
          if(!val || /Timestamp|Student ID/i.test(key)) continue;
          const qa = el('div',{ class:'qa' },[
            el('div',{ class:'label', text: key }),
            el('div',{ class:'value' }, [ safeText(val) ])
          ]);
          wrap.appendChild(qa);
          renderedKeys.add(key);
        }

        // Render any remaining fields
        Object.entries(row).forEach(([lab,val])=>{
          if(!val || renderedKeys.has(lab) || /Timestamp|Student ID/i.test(lab)) return;
          const qa = el('div',{ class:'qa' },[
            el('div',{ class:'label', text: lab }),
            el('div',{ class:'value' }, [ safeText(val) ])
          ]);
          wrap.appendChild(qa);
        });

        modalBody.appendChild(wrap);
      });

      openDialog();
    }

    function openDialog(){
      modal.classList.add('show');
      modal.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
      closeBtn.focus();
    }
    function closeDialog(){
      modal.classList.remove('show');
      modal.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
    }
    closeBtn.addEventListener('click', closeDialog);
    modal.addEventListener('click', (e)=>{ if(e.target.dataset.close==='backdrop') closeDialog(); });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && modal.classList.contains('show')) closeDialog(); });

    /* Exports */
    function downloadHTML(evt, rt, sum, resps){
      const parts = [];
      parts.push(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${escapeHtml(evt)}</title>`);
      parts.push(`<style>body{font-family:Arial,Helvetica,sans-serif;padding:2rem;color:#000;}h2{margin:.5rem 0}</style></head><body>`);
      parts.push(`<div style="margin-bottom:2rem">`);
      parts.push(`<img src="https://i.imgur.com/xFzbl45.png" alt="CAB Logo" style="height:50px;margin-bottom:1rem;">`);
      parts.push(`<h2>${escapeHtml(evt)}</h2>`);
      if(rt) parts.push(`<div>${stars(rt)} (${rt.toFixed(1)}/5.0)</div>`);
      if(sum) parts.push(`<div style="font-style:italic">${escapeHtml(sum)}</div>`);
      parts.push(`</div>`);

      resps.forEach((row,j)=>{
        parts.push(`<div style="border:1px solid #ccc;padding:1rem;margin:1rem 0;border-radius:8px">`);
        parts.push(`<h4>Response #${j+1}</h4>`);
        Object.entries(row).forEach(([lab,val])=>{
          if(!val || /Timestamp|Student ID|Which Event/i.test(lab)) return;
          parts.push(`<div style="margin:.3rem 0"><strong>${escapeHtml(lab)}:</strong> ${escapeHtml(String(val))}</div>`);
        });
        parts.push(`</div>`);
      });

      parts.push(`</body></html>`);
      const blob = new Blob([parts.join('')], {type:'text/html'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${slug(evt)}.html`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function downloadCSV(evt, resps){
      const headers = Array.from(new Set(resps.flatMap(r=>Object.keys(r))))
        .filter(h=>!/(Timestamp|Student ID)/i.test(h));
      const rows = [headers.join(',')].concat(
        resps.map(r=> headers.map(h=>csvEscape(r[h] ?? '')).join(','))
      );
      const blob = new Blob(["\ufeff"+rows.join('\n')],{type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href=url; a.download = `${slug(evt)}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function csvEscape(v){
      const s = String(v).replaceAll('"','""');
      return /[",\n]/.test(s) ? `"${s}"` : s;
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'",'&#39;');
    }

    function slug(s){
      return String(s).toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');
    }

    /* UI events */
    const searchEl = document.getElementById('search');
    const sortEl = document.getElementById('sortMode');

    function debounce(fn, wait=200){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),wait); } }
    const onSearch = debounce(e=>render(e.target.value, sortEl.value), 200);

    searchEl.addEventListener('input', onSearch);
    sortEl.addEventListener('change', e=>render(searchEl.value, e.target.value));
  </script>
</body>
</html>
